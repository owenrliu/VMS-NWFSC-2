---
title: "Fisher Behavioral Strategies"
author: "Owen Liu"
date: Last Run "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F,warning=F,message=F)
options(dplyr.summarise.inform = FALSE)
options(tidyverse.quiet = TRUE)
library(tidyverse)
library(magrittr)
library(here)
library(NbClust)
library(viridis)
library(lubridate)
library(ggsci)
library(forcats)
library(rnaturalearth)
library(sf)
library(corrplot)
library(ggrepel)
library(factoextra)
library(cowplot)
library(ggalluvial)

# ggplot theme
plot_theme <-   theme_minimal()+
  theme(text=element_text(family="sans",size=10,color="black"),
        legend.text = element_text(size=10),
        axis.title=element_text(family="sans",size=14,color="black"),
        axis.text=element_text(family="sans",size=8,color="black"),
        panel.grid.major = element_line(color="gray50",linetype=3))
theme_set(plot_theme)
```

## Purpose

The goal of this analysis is to perform a clustering analysis on a suite of behavioral metrics describing the 2009-2019 west coast Dungeness crab fishing fleet. The metrics have been compiled based on fish ticket and VMS data, and include information on port use, revenue, and trip lengths, as well as more advanced metrics from analysis of VMS data, like distance traveled, exploratory behavior and propensity to fish in high winds.

All metrics (to the extent data allow) were calculated for each vessel and crab season. The unit of observation in clustering is one vessel's crab season, e.g. Vessel A in crab season 2012-2013.

Our guiding questions are:

1. **Can the behavior of the west coast Dungeness crab fishing fleet be classified into distinct behavioral types?**
2. **Which behavioral variables are particularly important in defining these behavioral types?**
3. **Have individual vessels moved between behavioral types across years?**
4. **How do fishing behavioral strategies relate to revenue and landings from fishing?**

## Import Data

```{r}
dat <- read_rds(here::here('fishing behavior','fishing_behavior_metrics_vessel_season_final.rds')) %>% 
  # filter(crab_season!="2008-2009") %>% 
  distinct()
glimpse(dat)
```

```{r}
# all DCRB fish tickets
fishtix <- read_rds(here::here('data','processed','fish tickets','fish_tickets_w_dayofseason.rds'))
# long form fish tickets with all species (for investigating other revenue)
fishtix_long <- read_rds(here::here('data','processed','fish tickets','fish_tickets_long_allspecies.rds'))
# for both sets of fish tickets, we do not make calculations on pre-season tickets
fishtix %<>% filter(ticket_day_of_season>=0)
fishtix_long %<>% filter(ticket_day_of_season>=0)

# vms_rep <- read_rds(here('fishing behavior','vms_proportional_landings_key.rds'))
vms_tickets <- read_rds(here('fishing behavior','fish_tickets_with_vms.rds'))
recid_crabseason <- fishtix %>% select(Rec_ID,crab_season) %>% distinct()

# import vms data as well, to pull out trip duration in days
vms <- purrr::map_df(2009:2019, function(yr){
  read_rds(paste0(here::here('data','processed','matched','filtering',yr),"matched_filtered.rds"))
}) %>% 
  filter(TARGET_rev=='DCRB') %>% 
  # join crab season indicator
  left_join(recid_crabseason,by='Rec_ID') %>% 
  filter(!is.na(crab_season))

vms_all_grd <- read_rds(here::here('data','processed','vms','vms_all_w_grd.rds'))
vms_all_grd %<>%
  dplyr::filter(TARGET_rev=='DCRB') %>% 
  # join crab season indicator
  left_join(recid_crabseason,by='Rec_ID')

trip_duration_key <- vms %>% 
  distinct(Rec_ID,trip_dur)

#vessel size
vessel_sizes <- read_rds(here::here('fishing behavior','vessel_sizes.rds')) %>% group_by(drvid,crab_season) %>% slice(1)

# vessels in both VMS and fish ticket data
vms_fishtix_vessels <- intersect(unique(fishtix$drvid),unique(vms$drvid))

# consumer price index (for inflation adjustments)
#https://www.minneapolisfed.org/about-us/monetary-policy/inflation-calculator/consumer-price-index-1913-
cpi <- read_csv(here('data','raw','cpi_2021.csv'),col_types='idc')
# baseline is 1982-1984 $$
# add a conversion factor to 2010 $$
cpi %<>% 
  mutate(convert2010=1/(annual_average/218.1)) %>% 
  filter(year>2003) %>% 
  dplyr::select(year,convert2010)

#state-specific fuel prices
fuel <- read_csv(here('data','raw','state_average_fuel_prices.csv'))

# pacfin species identifiers
pacfin_spid <- read_csv(here('data','raw','pacfin_spid.csv'),col_types='icccc')
```

```{r}
# convert revenue in all revenue observations to 2010 dollars
fishtix %<>%
  # do the $$ conversion factor to 2010 dollars
  left_join(cpi,by='year') %>% 
  mutate(across(contains('revenue'), ~.x*convert2010))

fishtix_long %<>%
  # do the $$ conversion factor to 2010 dollars
  left_join(cpi,by='year') %>% 
  mutate(across(c(spp_revenue,tot_revenue_spp), ~.x*convert2010)) %>% 
  dplyr::select(-convert2010)

vms %<>%
  mutate(year=year(date)) %>% 
  # do the $$ conversion factor to 2010 dollars
  left_join(cpi,by='year') %>% 
  mutate(across(c(other_rev,SABL_revenue,DCRB_revenue,LOBS_revenue,SPRW_revenue), ~.x*convert2010)) %>% 
  dplyr::select(-convert2010,-year)

vms_all_grd %<>%
  mutate(year=year(date)) %>% 
  # do the $$ conversion factor to 2010 dollars
  left_join(cpi,by='year') %>% 
  mutate(across(c(other_rev,SABL_revenue,DCRB_revenue,LOBS_revenue,SPRW_revenue), ~.x*convert2010)) %>% 
  dplyr::select(-convert2010,-year)
```

```{r}
## Coastline
coaststates <- ne_states(country='United States of America',returnclass = 'sf') %>% 
  filter(name %in% c('California','Oregon','Washington','Nevada')) %>% 
  st_transform(st_crs(vms_all_grd))
```


More specifically, the metrics are as follows for each vessel (`drvid`) in each `crab_season`:

1.  Port use: 
  *  `n_ports_trip` Average ports visited per trip
  *  `ports_mean_mth` Number of ports visited per month 
  *  `port_diversity` Inverse Simpson diversity index of port use
  *  `total_ports` Total number of ports visited across the entire season
2.  Revenue: 
  *  `revenue_mean` Mean Dungeness revenue per trip
  *  `revenue_sd` SD revenue per trip
3.  Landings:
  *  `landings_mean` Mean Dungeness landings (lbs) per trip
  *  `landings_sd` SD landings per trip
4.  Trip Length: 
  *  `trip_dist_mean` Mean distance per fishing trip, 
  *  `trip_dur_mean` Mean number of days per fishing trip
  *  `trip_dist_sd` SD distance per trip
  *  `trip_dur_sd` SD days per trip
5.  Derby fishing:
  *  `quant90_day` Day-of-season on which fisher reach 90% of eventual annual catch
6.  Participation in other fisheries:
  *  `prop_other_revenue` Proportion of revenue from non-DCRB fisheries
  *  `prop_other_tix` Proportion of all fish tickets form non-DCRB fisheries
  *  `revenue_diversity` Inverse Simpson diversity index of revenue by fishery (species)
7.  Risk-taking:
  *  `prop_highwinds` Propensity to fish in high winds. Proportion of trips pursued where the 95% quantile of wind speed was greater than 7.5 m/s
8.  Exploration: 
  *  `entropy_quant90` Cumulative choice entropy, measuring how likely a vessel is to fish in new versus past locations
9.  Mobility:
  * `homerange` Home range defined as the area of the convex hull surrounding all of a vessel's VMS pings during the season, excluding the top 5% spatial outliers
10. Vessel size


Because we are interested here in a post-hoc analysis of how fishing behaviors correlate with revenue and landings, we remove revenue and landings metrics from the clustering analysis and instead investigate their relationships with the derived behavioral groups later.

## Check Collinearity

Before clustering, we take a look at all the variables to search for extreme collinearity, which would suggest that we should trim our variables down.

```{r}
vars.corrs <- dat %>% select(-(1:2),-revenue_mean,-revenue_sd,-landings_mean,-landings_sd) %>% 
  cor(use="complete.obs") %>% 
  as_tibble(rownames="var1") %>% 
  pivot_longer(-var1,names_to = "var2",values_to = "corr")

vars.corrs %>% filter(corr !=1) %>% distinct(corr,.keep_all = T) %>% arrange(desc(corr)) %>% slice(1:15) %>% knitr::kable()

vars.corrs %>% 
  ggplot(aes(var1,var2,fill=corr))+
  geom_tile()+
  coord_equal()+
  scale_fill_gradient2()+
  labs(x="",y="",title="Variable Pearson Correlation Matrix",fill="")+
  theme(axis.text.x = element_text(angle=90,vjust=0.5,hjust=1))
```

There are some correlated variables, but few are greater than 0.7. Fishing trip distance and standard deviation are highly correlated, as well as three measures of port use (port diversity, ports per trip, and total ports). Additionally, the proportion of non-Dungeness tickets and non-Dungeness revenue are highly correlated.

We thin the clustering variables by removing mean and SD of trip distance (`trip_dist_mean` and `trip_dist_sd`), total ports (`total_ports`), and non-Dungeness ticket proportion (`prop_other_tix`) from further analysis. The remaining variables have no correlations higher than 0.7.

## Re-scale variables

For clustering analyses, we need to re-scale variables to a 0 to 1 scale to avoid artifacts caused simply by scale differences between variables.

Re-scaling is done by subtracting the mean of each variable and dividing by its SD.

```{r}
# which variables are most commonly missing?
check_missing <- dat %>% summarise(across(everything(),~sum(is.na(.))))

dat_scaled <- dat %>% 
  select(-revenue_mean,-revenue_sd,-landings_mean,-landings_sd,-trip_dist_sd,-total_ports,-prop_other_tix,-trip_dist_mean) %>% 
  # remove any observations with any missing variables
  drop_na() %>% 
  # now scale
  mutate_at(-(1:2),~./max(.))
```

## Do Clustering

We then perform a clustering of the data, using Ward aggregation that attempts to minimize total within-cluster variance. However, instead of choosing the number of resulting classes rather arbitrarily from the results, we utilize the package `NbClust` that calculates 22 clustering indices defined in the literature, and then recommends the optimal number of clusters via majority vote.

```{r,results=FALSE,include=FALSE}
dat_clust <- dat_scaled %>% select(-(1:2)) %>% NbClust(method="kmeans",min.nc = 4,max.nc=6,index='all')
```

```{r}
# write_rds(dat_clust,here('fishing behavior','FBT_clusters_final.rds'))
# dat_clust <- read_rds(here('fishing behavior','FBT_clusters_final.rds'))
```

## Visualize Clustering

```{r,include=FALSE,eval=FALSE}
dat_clust$All.index %>% as.tibble(rownames="n_clust")
dat_clust$All.CriticalValues
dat_clust$Best.partition %>% length()
```

We apply the majority-rule partitions from clustering to the dataset.

```{r}
dat_clustered <- dat_scaled %>% na.omit() %>% 
  mutate(partition=dat_clust$Best.partition) %>% 
  as_tibble()
# write_rds(dat_clustered,here::here('fishing behavior','data_scaled_4clusters.rds'))
```


```{r}
dat_nolabs <- dat_scaled %>% na.omit() %>% select(-(1:2))

```

We can also use the same data to perform a principal component analysis to help visualize our groups.

```{r}
dat_for_pca <- dat_scaled %>% 
  na.omit() %>% 
  select(-(1:2)) %>% 
  rename(`Ports per Trip`=n_ports_trip,
         `Ports per Month`= ports_mean_mth,
         `Port Diversity`= port_shannon,
         `Mean Trip Duration` = trip_dur_mean,
         `SD Trip Duration` = trip_dur_sd,
         `Season Length` = quant90_day,
         `Non-Dungeness Revenue` = prop_other_revenue,
         `Revenue Diversity` = revenue_diversity,
         `Risk Taking` = prop_highwinds,
         `Location Entropy` = entropy_quant90,
         `Home Range Size` = homerange,
         `Vessel Size` = vessel_size
         )
dat.pca <- FactoMineR::PCA(dat_for_pca,graph=FALSE)

```

```{r,fig.height=5,fig.width=6}
# names for groups
clustnames <- tibble(partition=dat_clust$Best.partition) %>%
  mutate(partition=case_when(
    partition==1 ~ "Roving Specialists",
    partition==2 ~ "Local Generalists",
    partition==4 ~ "Roving Generalists",
    partition==3 ~ "Local Specialists"
  )) %>%
  mutate(partition=factor(partition,levels=c("Local Specialists","Local Generalists","Roving Specialists","Roving Generalists")))

p <- viridis_pal(begin=0.2,end=0.8)(4) # color palette
cluster_pca <- fviz_pca(dat.pca,geom.ind="",
         col.ind=clustnames$partition,
         addEllipses=TRUE,col.var="black",
         palette=p,alpha.ind=1,repel=T)+
  labs(color="Behavioral Cluster",shape="Behavioral Cluster",fill="Behavioral Cluster",shape="Behavioral Cluster",title="")+
  scale_x_continuous(expand = c(.1,0),limits=c(-5,6))+
  theme(panel.grid.major = element_blank(),panel.grid.minor=element_blank(),
        legend.background = element_rect())

cluster_pca
ggsave(here::here('fishing behavior','plots','PCA_clusters_nopts.png'),cluster3_pca,w=8,h=6)
# scree plot
fviz_eig(dat.pca,choice = 'variance')
```

As another visualization of differences between clusters, we can look at distribution of specific variable values across groups in boxplots.

```{r,fig.height=8,fig.width=8}
library(multcompView)
find_multcompletters <- function(df){
  aovtemp <- aov(df,formula = value~partition)
  tukeyhsd <- TukeyHSD(aovtemp)
  multcompLetters(tukeyhsd$partition[,4])$Letters %>% 
    enframe(name='partition',value='letter') %>% 
    mutate(partition=as.factor(partition))
}
group_means <- dat %>%
  select(-drvid,-crab_season,-revenue_mean,-revenue_sd,-landings_mean,-landings_sd,-trip_dist_sd,-total_ports,-prop_other_tix,-trip_dist_mean) %>%
  rename(`Ports per Trip`=n_ports_trip,
         `Ports per Month`= ports_mean_mth,
         `Port Diversity`= port_shannon,
         `Mean Trip Duration` = trip_dur_mean,
         `SD Trip Duration` = trip_dur_sd,
         `Season Length` = quant90_day,
         `Non-Dungeness Revenue` = prop_other_revenue,
         `Revenue Diversity` = revenue_diversity,
         `Risk Taking` = prop_highwinds,
         `Location Entropy` = entropy_quant90,
         `Home Range Size` = homerange,
         `Vessel Size` = vessel_size
         ) %>%
  drop_na() %>%
  mutate(partition=dat_clust$Best.partition %>% as.factor()) %>%
  mutate(partition=case_when(
    partition==3 ~ "LS",
    partition==1 ~ "RS",
    partition==4 ~ "RG",
    partition==2 ~ "LG"
  )) %>% 
  
  pivot_longer(-partition,names_to='variable',values_to = 'value') %>%
  group_by(variable) %>%
  nest() %>%
  mutate(plotvars=purrr::map2(variable,data,function(j,k){
    labels=find_multcompletters(k)
    k %>%
      left_join(labels,by='partition') %>%
      ggplot(aes(factor(partition),value,fill=factor(partition)))+
      geom_boxplot(col='gray50')+
      geom_text(aes(partition,y=(max(value)-min(value))*0.9+min(value),label=letter),check_overlap = T,nudge_x=-0.15,size=4)+
      scale_fill_manual(values=c(p[2],p[1],p[4],p[3]))+
      labs(y="",x="",title=j)+
      guides(fill='none')+
      theme(title = element_text(size=8))
  })) %>%
  ungroup()

library(cowplot)

group_boxes <- plot_grid(plotlist=group_means$plotvars,labels=LETTERS[1:nrow(group_means)])
ggsave(here::here('fishing behavior','plots','groups_boxplots.png'),group_boxes,w=8,h=8)

group_boxes

```

Letters in the plot above show the results of Tukey's honest significant difference test between the values of each variable amongst classes. We can use these to further define each class, and give each a nickname: Local Generalists, Local Specialists, Roving Generalists, and Roving Specialists.

1. Local Generalists are associated with lower values of the port use metrics, the 2nd-lowest in trip duration. This group has the 2nd-shortest seasons and 2nd-lowest entropy among groups, with small home range, and 2nd-lowest risk-taking behavior. However, this group is associated with the 2nd-largest proportion of non-Dungeness revenue, and has the greatest revenue diversity.

2. Local Specialists have the most localized and smallest vessels, with the smallest home ranges and shortest trips. These vessels have the longest Dungeness seasons of any group, the lowest risk-taking behavior, and are specialized in Dungeness fishing, having the lowest proportion of non-Dungeness revenue and lowest revenue diversity.

3. The Roving Generalists group is composed of the largest vessels that visit the 2nd-most ports, take the longest trips, and have high choice entropy and large home ranges. However, they have the shortest mean (Dungeness crab) season length. They have the highest values for risk-taking behavior, and participate in many other fisheries, as indicated by their high values for proportion of outside revenue.

4. The Roving Specialists group is associated with the second-largest vessels on average and has the largest values in most of the port metrics, high number of total ports visited per trip and per month, and largest port use diversity. It is also associated with the second highest trip durations. This group is associated with the 2nd-longest seasons, largest choice entropy, largest home range, and 2nd-largest risk taking, but has the 2nd-lowest outside revenue and revenue diversity.

Together, these groups can be conceptualized along two axes---spatial behavior and fishery participation. Groups 3 and 4 display high choice entropy, visit many ports, and have larger home ranges, whereas groups 1 and 2 display much more fidelity to small home ranges and reduced numbers of ports. However, in looking at participation of these fishers in other fisheries, it is groups 2 and 3 that exhibit the greatest fidelity to the Dungeness fishery, while groups 1 and 4 participate in many other fisheries. This participation in other fisheries is also manifest in their season lengths, which are shortest for groups 1 and 4.

Consequently, for the rest of the results, we refer to these groups as Roving (i.e., exploratory, high port use, etc.) versus Local, and Specialist (Dungeness-specific) versus Generalist (participates in many fisheries).

```{r}
# Table of group definitions based on mean value of metrics
groups_table <- tibble(
  `Local Generalists`=  c(3,3,3,3,2,3,2,1,3,3,3,3),
  `Local Specialists` = c(3,4,3,4,1,1,4,4,3,4,3,4),
  `Roving Specialists` = c(1,1,1,2,3,2,3,3,2,1,1,2),
  `Roving Generalists` = c(2,2,2,1,4,4,1,2,1,1,2,1)) %>% 
  mutate(metric=c("Ports per Trip",
         "Ports per Month",
         "Port Diversity",
         "Mean Trip Duration",
         "SD Trip Duration",
         "Season Length",
         "Non-Dungeness Revenue",
         "Revenue Diversity",
         "Risk Taking",
         "Location Entropy",
         "Home Range Size",
         "Vessel Size")) %>% 
  pivot_longer(cols=1:4,names_to="Group") %>% 
  mutate(metric=factor(metric,levels=c("Ports per Trip",
         "Ports per Month",
         "Port Diversity",
         "Mean Trip Duration",
         "SD Trip Duration",
         "Season Length",
         "Home Range Size",
         "Non-Dungeness Revenue",
         "Revenue Diversity",
         "Risk Taking",
         "Location Entropy",
         "Vessel Size")))

groups_table_plot <- groups_table %>% 
  ggplot(aes(metric,Group,fill=factor(value)))+
  geom_tile()+
  geom_text(aes(label=value))+
  labs(x="Metric",y="")+
  coord_fixed()+
  scale_fill_manual(values=rev(RColorBrewer::brewer.pal(4,"Blues")),guide='none')+
  theme(axis.text.x = element_text(angle=45,vjust=1,hjust=1),
        panel.grid.major=element_line(linetype=1))
groups_table_plot
ggsave(here::here('fishing behavior','plots','groups_rankings_plot.png'),groups_table_plot,w=6,h=4)
```

```{r}
## Add factor levels/names to clustered data
dat_clustered <- dat_clustered %>%
  mutate(partition=case_when(
    partition==1 ~ "Roving Specialists",
    partition==2 ~ "Local Generalists",
    partition==4 ~ "Roving Generalists",
    partition==3 ~ "Local Specialists")) %>%
  mutate(partition=factor(partition,levels=c("Local Specialists","Local Generalists","Roving Specialists","Roving Generalists")))

vessel_list <- unique(dat_clustered$drvid)
```

## Variable Importance

We can investigate the contribution of individual variables to the eventual classification. We use random forests in the package `randomForest` to see which variables contribute most to classification.

Random forests are built from a number of individual classification trees (we use 1000). Each tree is built by recursive binary partitioning of the data, using a predictor variable (e.g., `trip_dur_mean`) to make a split in the data to create the most homogenous subgroups, where homogeneity is measured by the Gini coefficient on the relative proportions of group (Group 1, 2, 3, or 4) membership. The tree keeps dividing until the Gini index no longer declines with further splitting, at which point the tree is "fully grown".

Random forests build many of these trees, with two differences from single classification trees. First, for each tree, only a bootstrapped subsample of the original data is chosen for classification. Second, only a subset of the predictor variables are "available" to the tree for binary partitioning, chosen randomly. Therefore, each tree is twice randomized---first through bootstrapping, and then through the random selection of partitioning variables; hence creating the "random forest". Once many trees are grown from the bootstrapped sample, the classes for the observations from the original data set that were not chosen for fitting (known as out-of-bag observations) are predicted by each tree in the forest. We compile the rate at which the forest mis-classifies observations into the incorrect class. The measure of variable importance is the *change* in this mis-classification rate when a variable is randomly permuted in the out-of-bag sample. In other words, we measure how much worse our classification performs without the correctly-ordered variable.

```{r}
variable_name_matches <- tibble(
  v=c("n_ports_trip","ports_mean_mth","port_shannon","trip_dur_mean","trip_dur_sd","quant90_day","prop_other_revenue","revenue_diversity","prop_highwinds","entropy_quant90","homerange","vessel_size"),
  metric=c("Ports per Trip",
         "Ports per Month",
         "Port Diversity",
         "Mean Trip Duration",
         "SD Trip Duration",
         "Season Length",
         "Non-Dungeness Revenue",
         "Revenue Diversity",
         "Risk Taking",
         "Location Entropy",
         "Home Range Size",
         "Vessel Size"))
```

We apply this procedure to our data, using our four groups and growing 1000 trees.

```{r,fig.width=4.5,fig.height=5}
dat_nolabs <- dat_clustered %>% 
  na.omit() %>% 
  select(-(1:2)) %>% 
  mutate(partition=as.factor(partition))

library(randomForest)
rf <- randomForest(partition~.,data=dat_nolabs,importance = TRUE,ntree=1000)
var_imp <- rf$importance %>% as_tibble(rownames="variable") %>% 
  select(variable,MeanDecreaseAccuracy) %>% 
  mutate(rel_imp=MeanDecreaseAccuracy*100)
rel_imp_plot <- var_imp %>% 
  left_join(variable_name_matches,by = c("variable"="v")) %>%
  mutate(varname=factor(variable,levels=variable)) %>%
  arrange(desc(rel_imp)) %>% 
  ggplot(aes(x=fct_reorder(metric,rel_imp),y=rel_imp))+
  geom_col()+
  # scale_y_continuous(breaks=seq(0,10,by=2))+
  labs(x="Metric",y="Relative Importance")+
  coord_flip()+
  theme(axis.text.x = element_text(angle=45,vjust=1,hjust=0.8,size=8),
        panel.grid.major = element_blank(),
        panel.grid.minor=element_blank(),
        axis.title.x = element_text(size=10),
        axis.title.y=element_text(size=10))

# With vessel size
vessel_sizes <- read_rds(here::here('fishing behavior','vessel_sizes.rds')) %>% group_by(drvid,crab_season) %>% slice(1)
dat_nolabs_vesselsize <- dat_clustered %>% 
  na.omit() %>%
  left_join(vessel_sizes)%>% 
  na.omit() %>% 
  select(-(1:2)) %>% 
  mutate(partition=as.factor(partition))

rel_imp_plot
```

```{r}
# simple plot to show groups
gids <- factor(c('Local Specialists','Local Generalists','Roving Specialists','Roving Generalists'))
pos <- tibble(id=rep(gids,each=4),
              x=c(0,1,1,0,0,1,1,0,1,2,2,1,1,2,2,1),
              y=c(0,0,1,1,1,1,2,2,0,0,1,1,1,1,2,2))
texts <- tibble(id=gids,
                x=c(0.5,0.5,1.5,1.5),
                y=c(0.5,1.5,0.5,1.5))
simplified_groups_plot <- pos %>% ggplot()+
  geom_polygon(data=pos,aes(fill=id,x=x,y=y))+
  geom_text(data=texts,aes(label=id,x=x,y=y))+
  scale_fill_manual(values=c(p[2],p[1],p[4],p[3]),guide="none")+
  labs(x="Mobility, Ports Visited, Vessel Size, Fishing Range",y="Participation in Other Fisheries")+
  theme(panel.grid.major = element_blank(),
        panel.grid.minor=element_blank(),
        axis.title.x = element_text(size=10),
        axis.title.y=element_text(size=10),
        axis.text.x=element_blank(),
        axis.text.y=element_blank(),
        axis.line.y = element_line(arrow = grid::arrow(length = unit(0.3, "cm"), 
                                                       ends = "last",type="closed")),
        
        axis.line.x = element_line(arrow = grid::arrow(length = unit(0.3, "cm"), 
                                                       ends = "last",type='closed')))

simplified_groups_plot
```


```{r,fig.height=9,fig.width=7.5}
#combine with PCA
r2 <- plot_grid(rel_imp_plot,simplified_groups_plot,nrow=1,labels=c('b','c'))
fig_pca_rf <- plot_grid(cluster3_pca,r2,nrow=2,labels=c('a',''),rel_heights = c(1,0.8))

fig_pca_rf
# ggsave(here::here('fishing behavior','plots','fig_pca_rf.png'),fig_pca_rf,w=7.5,h=9)
# ggsave(here::here('fishing behavior','plots','fig_pca_rf.pdf'),fig_pca_rf,w=7.5,h=9)
```

## Vessel Size Distribution by Behavioral Group

Dialogue around the Dungeness crab fishery often focuses around vessel size (i.e., large vs. small boats). Our analysis suggests that although the behavioral groups are correlated with vessel size, there is substantial overlap in vessel size among the different groups, meaning that vessel size alone is insufficient to explain behavioral patterns. 

This is how vessel length maps on to behavioral groups in the fishery.

```{r}

vessel_length_dist_plot <-dat_clustered %>%
  ggplot(aes(vessel_size,fill=factor(partition)))+
  geom_density(alpha=0.5)+
  labs(x="Vessel Length",y='density',fill='Group',title="Vessel Length Distribution by Behavioral Group")+
  scale_fill_manual(values=viridis_pal(begin=0.2,end=0.8)(4))+
  facet_wrap(~crab_season)
vessel_length_dist_plot
ggsave(here::here('fishing behavior','plots','vessel_length_dist_by_group.png'),vessel_length_dist_plot,w=6,h=5)
```

While the largest vessels are mostly categorized as Roving Generalists and the smallest are mostly Local Specialists, the other two behavioral groups are made up of a wide range of intermediate vessel sizes.

We can also investigate the correlation of vessel size with other variables in the cluster analysis. As expected from the above, larger vessels are associated with longer trips, more exploratory behavior, risk-taking behavior (i.e. propensity to fish in high winds), and shorter seasons.

```{r}
vessel_length_corr_plot <- vars.corrs %>% 
  filter(var1=='vessel_size',var2 !='vessel_size') %>% 
  filter(!(var2 %in% c("revenue_mean","revenue_sd","landings_mean","landings_sd","vessel_size","trip_dist_sd","total_ports","prop_other_tix","trip_dist_mean"))) %>% 
  arrange(desc(corr)) %>% 
  left_join(variable_name_matches,by=c('var2'='v')) %>% 
  mutate(varname=factor(metric,levels=metric)) %>% 
  mutate(is_neg=ifelse(corr<0,"neg","pos")) %>% 
  ggplot(aes(varname,corr,fill=is_neg))+
  geom_col()+
  labs(x="Variable",y="Correlation with Vessel Length")+
  scale_fill_manual(values=c("red","blue"),name="")+
  scale_y_continuous(breaks=seq(-1,1,by=0.2))+
  guides(fill='none')+
  theme(axis.text.x = element_text(angle=90,vjust=0.5,hjust=1))
vessel_length_corr_plot
ggsave(here::here('fishing behavior','plots','vessel_length_correlations.png'),vessel_length_corr_plot,w=6,h=5)

```

## Class Transition Across Years

We have described the behavior of some broad groups of Dungeness crab fishers, and explored the importance of individual behavioral variables in distinguishing between groups. Next, we want to investigate how the total number of vessels in each class may have shifted over the course of years on our data, as well as explore interannual movements of individual vessels between the three classes.

```{r}
# key matching vessel-seasons to states
drvid_state_key <- fishtix %>%
  filter(drvid %in% vessel_list) %>% 
  distinct(drvid,crab_season,agency_code)

# count group membership in each year
class_by_yr <- dat_clustered %>% 
  group_by(crab_season,partition) %>% 
  summarise(n_vessels=n_distinct(drvid)) %>% 
  ungroup()
# class_by_yr %>%
#   ggplot(aes(crab_season,n_vessels,fill=factor(partition)))+
#   geom_col()+
#   labs(x="Crab Season",y="Number of Vessels",title="Number of Vessels by Behavior Class and Year",fill="Group")+
#   scale_fill_manual(values=viridis_pal(begin=0.2,end=0.8)(4))+
#   theme(axis.text.x = element_text(angle=90,vjust=0.5),
#         legend.position = 'bottom')
num_vessels_timeseries <- class_by_yr %>% 
  ggplot(aes(crab_season,n_vessels,group=factor(partition),color=factor(partition)))+
  geom_line(size=2)+
  geom_vline(xintercept=7.5,linetype=2,col="darkred")+
  geom_vline(xintercept=10.5,linetype=2,col="darkred")+
  labs(x="Crab Season",y="Number of Vessels",title="",color="")+
  scale_color_manual(values=viridis_pal(begin=0.2,end=0.8)(4))+
  theme(axis.text.x = element_text(angle=90,vjust=0.5),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        legend.text = element_text(size=8),
        legend.position = 'bottom')
num_vessels_timeseries
ggsave(here::here('fishing behavior','plots','nvessels_groups.png'),num_vessels_timeseries,w=8,h=6)

# bar plots of heatwave vs. non-heatwave years
heatwave_barplot <- class_by_yr %>% 
  mutate(is_heatwave=ifelse(crab_season %in% c('2015-2016','2016-2017','2017-2018'),"MHW","Non-MHW")) %>% 
  mutate(is_heatwave=factor(is_heatwave,levels=c("Non-MHW","MHW"))) %>% 
  group_by(partition,is_heatwave) %>% 
  summarise(mean_vessels=mean(n_vessels),sd_vessels=sd(n_vessels)) %>% 
  ungroup() %>% 
  ggplot(aes(partition,mean_vessels,fill=is_heatwave))+
  scale_fill_manual(values=c("#3B4992FF","#EE0000FF"))+
  scale_color_manual(values=c("#3B4992FF","#EE0000FF"))+
  geom_col(position=position_dodge(),col='black')+
  geom_errorbar(aes(partition,mean_vessels,group=is_heatwave,ymin=mean_vessels-sd_vessels,ymax=mean_vessels+sd_vessels),
                position=position_dodge(0.9),width=0.2)+
  theme(panel.grid.major=element_blank(),
        panel.grid.minor=element_blank(),
        legend.position = c(0.8,0.8))+
  labs(x="Behavioral Group",y="Number of Vessels",fill="Period")
heatwave_barplot
ts_heatwave_groups_plot <- plot_grid(num_vessels_timeseries,heatwave_barplot,labels = "auto",nrow = 2)

ggsave(here::here('fishing behavior','plots','timeseries_and_heatwave_groups.png'),ts_heatwave_groups_plot,w=6,h=8)
```

### Flows Between Groups

We can also look at the flows of vessels between classes and years.

```{r,warning=F,message=F}
dat_alluvium <- dat_clustered %>%
  # left_join(drvid_foo) %>% 
  select(drvid,crab_season,partition) %>% 
  distinct(drvid,crab_season,.keep_all=T) %>% 
  mutate(partition=as.character(partition),
         crab_season=factor(crab_season,levels=unique(dat_clustered$crab_season))) %>% 
  # group_by(crab_season,partition) %>% 
  # mutate(freq=n_distinct(drvid)) %>% 
  ungroup() %>% 
  arrange(crab_season)

# with boats not fishing in a given season
behavioral_group_flows<- dat_alluvium %>% 
  ggplot(aes(x=crab_season,stratum=partition,alluvium=drvid,fill=partition,label=partition))+
  geom_flow(na.rm=T,color='darkgray')+
  geom_stratum(na.rm=T)+
  scale_fill_manual(values=c(p[2],p[1],p[4],p[3],'gray50'),name="Group")+
  theme(axis.text.x = element_text(angle=90,vjust=0.5),
        panel.grid.major=element_blank(),
        panel.grid.minor=element_blank())+
  labs(x="Crab Season",y="Number of Vessels")

behavioral_group_flows
ggsave(here('fishing behavior','plots','behavioral_group_flows.png'),behavioral_group_flows,w=8,h=6)
```

From this figure we can see substantial flows between groups in certain years. For example, many vessels classified as Local Generalists joined the other groups between the 2008 and 2009 crab seasons. Similarly, after the 2014-15 crab season, many Local Generalists became Local Specialists or Roving Generalists.

```{r}
# key of vessel-seasons vs. classified group
drvid_group_key <- dat_clustered %>% select(drvid,crab_season,partition) %>% 
  distinct()

drvid_other_fisheries <- fishtix_long %>% 
  filter(drvid %in% vessel_list,crab_season != "2019-2020") %>%  # filter for in-season weeks
  filter(ticket_day_of_season>=0) %>% 
  distinct() %>% 
  # calculate DCRB vs. non-DCRB revenue
  mutate(is_DCRB=PACFIN_SPECIES_CODE=="DCRB") %>% 
  group_by(drvid,agency_code,crab_season) %>% 
  summarise(DCRB_revenue=sum(spp_revenue[is_DCRB]),other_revenue=sum(spp_revenue[!is_DCRB])) %>% 
  ungroup() %>% 
  mutate(DCRB_revenue=coalesce(DCRB_revenue,0),other_revenue=coalesce(other_revenue,0)) %>% 
  complete(drvid,crab_season) %>%
  # add partition information
  left_join(drvid_group_key) %>% 
  # check if missing seasons are because No VMS
  left_join(novms_key) %>% 
  distinct() %>% 
  # for missing data, clarify between stop fishing (no fish tickets recorded) versus fishing other species
  # (i.e., no DCRB revenue, but other revenue evident)
  mutate(other_fishing=no_dcrb & other_revenue>0) %>% 
  mutate(not_fishing=no_vms & no_dcrb & !other_fishing) %>% 
  # use all the logicals to better define the partition for each vessel-season
  mutate(status=case_when(
    is.na(partition)& not_fishing ~ "Not Fishing",
    is.na(partition)& no_vms & !no_dcrb & !other_fishing ~ "No VMS Data",
    is.na(partition)&other_fishing ~ "Different Fishery",
    TRUE ~ "Not Fishing"
  )) %>% 
  mutate(status=coalesce(partition,status))

# transitions between all groups by season
trans_by_season <- drvid_other_fisheries %>%
  group_by(drvid,agency_code) %>%
  arrange(crab_season) %>% 
  mutate(last_status=dplyr::lag(status,1)) %>% 
  filter(!is.na(last_status)) %>% 
  filter(status != "No VMS Data", last_status != "No VMS Data") %>% 
  ungroup() %>% 
  count(crab_season,status,last_status) %>% 
  group_by(crab_season) %>% 
  mutate(tot_n=sum(n)) %>% 
  mutate(prop=n/tot_n)

# Most common transition types by crab season
trans_types_by_season <- drvid_other_fisheries %>%
  group_by(drvid) %>%
  arrange(crab_season) %>% 
  mutate(last_status=dplyr::lag(status,1)) %>% 
  filter(!is.na(last_status)) %>% 
  filter(status != "No VMS Data", last_status != "No VMS Data") %>% 
  ungroup() %>% 
  count(crab_season,status,last_status) %>% 
  group_by(crab_season) %>% 
  mutate(tot_n=sum(n)) %>% 
  mutate(transition_type=case_when(
    status=="Not Fishing" & last_status=="Not Fishing" ~ "Remain Not Fishing",
    status=="Different Fishery" & last_status=="Different Fishery" ~ "Remain in Different Fishery",
    status=="Not Fishing" & last_status!="Not Fishing" ~ "Stop Fishing",
    status=="Different Fishery" & last_status!="Different Fishery" ~ "Switch to Different Fishery",
    status!="Not Fishing" & last_status=="Not Fishing" ~ "Enter Non-crab Fishery",
    status!="Not Fishing"& status !="Different Fishery" & last_status=="Different Fishery" ~ "Enter Crab Fishery",
    status!="Not Fishing" & last_status!="Not Fishing" & status==last_status ~ "Same Group",
    status!= "Not Fishing" & last_status!="Not Fishing" & status != last_status ~ "Switch Groups"
    )) %>% 
  ungroup() %>% 
  group_by(crab_season,transition_type) %>% 
  summarise(n=sum(n),prop=n/tot_n) %>% 
  filter(crab_season != "2008-2009") %>% 
  distinct() %>% 
  mutate(transition_type=factor(transition_type,levels=c("Remain Not Fishing","Remain in Different Fishery","Switch to Different Fishery","Enter Non-crab Fishery","Enter Crab Fishery","Stop Fishing","Same Group","Switch Groups")))

transition_types_by_season_plot <- trans_types_by_season %>% 
  ggplot(aes(crab_season,n,group=transition_type,col=transition_type,fill=transition_type))+
  geom_line()+geom_point()+
  scale_fill_jco()+
  scale_color_jco()+
  labs(x="Crab Season",y="Number of Vessels",fill="Transition Type",col="Transition Type")+
  theme(axis.text.x=element_text(angle=90,vjust=0.5),
        panel.grid.major=element_blank(),
        panel.grid.minor=element_blank())
transition_types_by_season_plot
ggsave(here('fishing behavior','plots','behavioral_group_transitions.png'),transition_types_by_season_plot,w=8,h=6)
```
## Behavioral Class and Performance

Our last research question is, "*How do fishing behavioral strategies relate to revenue and landings from fishing?*". Now that we have the four groups of vessels, we can use these groups to explore how these behavioral strategies "perform" in terms of revenue and profits over the course of the season, and relative to the efficiency of crab capture (i.e., catch per unit effort).

### Additional Cost and Abundance Information

In order to compare the performance of the FBTs, we need to estimate the cost of fishing for each trip or vessel. We also have a record of estimated preseason abundance of crabs, which we can use to explore fisher performance as a function of available Dungeness biomass.

### Cost of Fishing

To measure cost of fishing, we adopt data from a survey done by Dewees et al. (2004). A survey was conducted of small, medium, and large size-class vessels. We use their mean estimates of annual and daily fishing costs to associate a cost with each trip. Dollar values are adjusted for inflation.

There are daily costs associated with vessel ownership that are associated with fuel, bait, and other variable costs like the fixing of traps. Additionally, there are costs associated with the entire fishing trip, most notably the share of revenues that go to crew. Larger vessels require more crew. Using The Dewees et al. survey values, we simulate the following relationships to estimate the cost of fishing trip $i$:

\begin{equation}
  C_i = d_iC_d + R_iC_c 
\end{equation}

\begin{equation}
  C_d = C_b + C_f + C_v
\end{equation}

\begin{equation}
  C_b =
    \begin{cases}
      N(66,73) & \text{$0<$length$<30$}\\
      N(178,269) & \text{$30<=$length$<=50$}\\
      N(261,188) & \text{otherwise}\\
    \end{cases}\\
\end{equation}
\begin{equation}
  C_f =
    \begin{cases}
      N(47,51)*r_{s,y} & \text{$0<$length$<30$}\\
      N(78.5,158)*r_{s,y} & \text{$30<=$length$<=50$}\\
      N(173,96)*r_{s,y} & \text{otherwise}\\
    \end{cases}\\
\end{equation}
\begin{equation}
  C_v =
    \begin{cases}
      N(46,62) & \text{$0<$length$<30$}\\
      N(47,62) & \text{$30<=$length$<=50$}\\
      N(72,33) & \text{otherwise}\\
    \end{cases}
\end{equation}

\begin{equation}
  C_c = 
  \begin{cases}
      N(0.15,0.1) & \text{$0<$length$<30$}\\
      N(0.24,0.11) & \text{$30<=$length$<=50$}\\
      N(0.31,0.1) & \text{otherwise}\\
  \end{cases}
\end{equation}

In the above equations, $C_i$ is total trip cost and $R_i$ is trip revenue as reported in the fish tickets. $C_d$, $C_c$, $C_b$, $C_f$, and $C_v$ represent total daily, crew, bait, fuel, and other variable costs, respectively, and $r_{s,y}$ is marine fuel cost relative to California in year $y$ (Figure A.16). We simulated 10,000 draws from the above distributions for all combinations of year (2008-2019) and state (California, Oregon, and Washington). This simulation allowed us to extract estimates of $C_d$ and $C_c$ for every trip in the data, which, when combined with individual trip revenue $R$, allows for a trip-specific fishing cost estimate (Figs. A.17, A.18). All costs were normalized to 2010 USD.

```{r}
#Update, 02/09/2022
# normalizing by state fuel price differences(relative to CA)
fuel <- fuel %>% 
  filter(STATE!="AK") %>% 
  group_by(STATE,YEAR) %>% 
  summarise(mean_gal=mean(avgpricegal)) %>% 
  ungroup()
calfuel <- fuel %>% 
  filter(STATE=="CA") %>% 
  dplyr::select(-STATE) %>% 
  rename(cafuel=mean_gal)
fuel <- fuel %>% 
  left_join(calfuel) %>% 
  mutate(ca_rel_fuel=mean_gal/cafuel)
relfuel_plot <- fuel %>% 
  ggplot(aes(YEAR,ca_rel_fuel,col=STATE))+
  geom_point()+
  geom_line()+
  labs(x="Year",y="Marine Fuel Price Relative to CA")
relfuel_plot
ggsave(here('fishing behavior','plots','relative_fuel_prices.png'),w=6,h=4)
```


```{r}
# daily costs function
# to make a smooth function, take means and SD from Dewees et al and sample, then fit a line
# in the sample, use min and max values from our dataset on vessel lengths
# convert 2004$ in Dewees et al. to 2010 values (multiply by 1.1545)

daily_cost_sim <- function(x,rel_fuel){
  # first term is bait, second is fuel, third is other variable costs
  if(x<30) cost<-(max(rnorm(1,65.8,72.7),0)+max(rnorm(1,47.3,50.8),0)*rel_fuel+max(rnorm(1,46.18,62.34),0))
  if(x>=30&x<=50) cost<-max(rnorm(1,178.95,269),0)+max(rnorm(1,78.5,158.17),0)*rel_fuel+max(rnorm(1,47.33,62.34),0)
  if(x>50) cost<-max(rnorm(1,260.92,188.18),0)+max(rnorm(1,173.18,95.82),0)*rel_fuel+max(rnorm(1,71.58,33.48),0)
  # bait, fuel, and other
  max(cost,0)
}

# also include debit for crew share (so these are costs to captain)
crew_share_sim <- function(x){
  if(x<30) share<-(rnorm(1,0.15,0.1))
  if(x>=30&x<=50) share<-rnorm(1,0.24,0.11)
  if(x>50) share<-rnorm(1,0.31,0.10)
  max(0,share)
}

cost_sim <- crossing(STATE=c("CA","OR","WA"),YEAR=2008:2019,vessel_length=runif(10000,21,104)) %>% 
  left_join(fuel) %>% 
  mutate(agency_code=case_when(
    STATE=="CA"~"C",
    STATE=="OR"~"O",
    STATE=="WA"~"W"
  )) %>% 
  mutate(daily_cost= purrr::map2_dbl(vessel_length,ca_rel_fuel,daily_cost_sim),
         crew_share=purrr::map_dbl(vessel_length,crew_share_sim)) %>% 
  # round vessel lengths and find means by year, state, and vessel size
  mutate(vessel_length_int=round(vessel_length,digits=1)) %>% 
  group_by(YEAR,agency_code,vessel_length_int) %>% 
  summarise(daily_cost=mean(daily_cost),
            crew_share=mean(crew_share))

# library(ggpubr)
cost_sim %>% 
  ggplot(aes(vessel_length_int,daily_cost,col=agency_code))+
  geom_point(size=0.5)+
  # geom_smooth(method='lm')+
  # stat_regline_equation()+
  labs(x="Vessel Length",y="Daily Cost",title="Daily Cost Simulation")
cost_sim %>% 
  ggplot(aes(vessel_length_int,crew_share))+
  geom_point(size=0.5)+
  # geom_smooth(method='lm')+
  # stat_regline_equation()+
  labs(x="Vessel Length",y="Crew Share",title="Daily Cost Simulation, Crew Share")

daily_cost_plot <- cost_sim %>% 
  filter(vessel_length_int%%1==0) %>% 
  ggplot(aes(vessel_length_int,daily_cost,col=agency_code))+
  geom_point(alpha=0.7)+
  geom_smooth(se=F)+
  facet_wrap(~YEAR)+
  scale_color_manual(values=viridis_pal(option="A",begin=0.2,end=0.8)(3))+
  labs(x="Vessel Length (ft)",y="Daily Fishing Cost (2010 USD)",col="State")

crew_share_plot <- cost_sim %>% 
  filter(vessel_length_int%%1==0) %>% 
  ggplot(aes(vessel_length_int,crew_share))+
  geom_point(alpha=0.7)+
  geom_smooth(se=F)+
  facet_wrap(~YEAR)+
  labs(x="Vessel Length (ft)",y="Crew Share (Proportion of Revenue)")

daily_cost_plot
crew_share_plot

ggsave(here('fishing behavior','plots','daily_cost_simulation.png'),daily_cost_plot,w=8,h=8)
ggsave(here('fishing behavior','plots','crew_share_simulation.png'),crew_share_plot,w=8,h=8)

```

```{r}
# function to pull out cost for a given vessel size, year, state, trip length, and revenue
trip_cost_fx <- function(vessel_size,year,state,num_days,trip_rev){
  costs<-cost_sim %>% filter(YEAR==year,agency_code==state,vessel_length_int==vessel_size)
  cost_daily=num_days*(costs %>% pull(daily_cost))
  crew_share <- trip_rev*(costs %>% pull(crew_share))
  cost_daily+crew_share
}
# trip_cost_fx <- function(vessel_size,num_days,trip_rev,trip_yr){
#   cost_daily<-(150+3.5*vessel_size)*num_days*1.02^(trip_yr-2004)
#   crew_share <- (0.17+0.0018*vessel_size)*trip_rev
#   cost_daily+crew_share
# }
```

### Calculate Performance Metrics

```{r}
# organize fish tickets by group and calculate metrics like cpue, trip length
fishtix_plus <- fishtix %>%
  # add information about how long each trip is
  left_join(trip_duration_key) %>% 
  ungroup() %>% 
  # dplyr::select only fish tickets that have associated vms information
  left_join(vms_tickets) %>% filter(has_vms==1) %>% dplyr::select(-has_vms) %>% 
  distinct(date,drvid,crab_season,agency_code,Rec_ID,DCRB_revenue,DCRB_lbs,SABL_revenue,LOBS_revenue,SPRW_revenue,trip_dur,start_of_season_oneperc) %>%
  # join cluster group/partition information
  left_join(drvid_group_key) %>% 
  filter(!is.na(partition)) %>%
  
  # calculate individual (vessel-level) weeks of the season
  # mutate(firstdate=min(date)) %>% 
  mutate(timediff=start_of_season_oneperc%--%date) %>% 
  mutate(week=time_length(timediff,'weeks')) %>% 
  mutate(week=floor(week)) %>% 
  dplyr::select(-timediff,-start_of_season_oneperc) %>%
  ungroup() %>%
  # filter for in-season weeks
  filter(week>=0) %>% 
  
  # calculate total landings in each state and week
  group_by(agency_code,crab_season,week) %>% 
  mutate(landings_state_week=sum(DCRB_lbs,na.rm=T)) %>% 
  ungroup() %>% 
  
  # calculate cumulative landings by state
  group_by(agency_code,crab_season) %>% 
  arrange(date) %>% 
  mutate(cumulative_landings=cumsum(DCRB_lbs),cumulative_landings_thousand_mt=cumulative_landings/1000/2204.63) %>% 
  #join Richerson's abundance data
  # left_join(abun) %>% 
  # # calculate the remaining biomass in each state by subtracting landings from preseason abundance
  # mutate(thousand_mt_remaining=mean_preseason_abun-cumulative_landings_thousand_mt) %>% 
  # # calculate the proportion remaining of the original biomass
  # mutate(prop_remaining=thousand_mt_remaining/mean_preseason_abun) %>% 
  # mutate(prop_remaining=pmax(0,prop_remaining)) %>% 
  # # filter(!is.na(prop_remaining)) %>% 
  ungroup() %>% 
  
  # cpue is lbs caught divided by days fished
  mutate(cpue=DCRB_lbs/trip_dur) %>% 

  # using the cost simulation above, calculate the cost and profit estimated for each trip
  # add trip duration and cost to each ticket
  left_join(vessel_sizes) %>% 
  mutate(trip_year=year(date)) %>% 
  mutate(trip_cost=purrr::pmap_dbl(list(vessel_size,trip_year,agency_code,trip_dur,DCRB_revenue),trip_cost_fx)) %>% 
  mutate(trip_profit=DCRB_revenue-trip_cost)
```

### Metrics by Group and Week

```{r}
metrics_by_partition_week<-fishtix_plus %>%
  ungroup() %>% 
  group_by(partition,week) %>%
  summarise(n_tix=n_distinct(Rec_ID),
            n_vessels=n_distinct(drvid),
            # mean_prop_remaining=mean(prop_remaining,na.rm=T),
            mean_catch=mean(DCRB_lbs,na.rm=T),
            mean_cpue=mean(cpue,na.rm=T),
            log_mean_cpue=log(mean(cpue,na.rm=T)),
            mean_trip_dur=mean(trip_dur,na.rm=T),
            mean_revenue_group=mean(DCRB_revenue),
            mean_cost_group=mean(trip_cost),
            mean_profit_per_trip=mean(trip_profit,na.rm=T),
            mean_profit_per_day=mean(trip_profit,na.rm=T)/mean(trip_dur,na.rm=T),
            mean_costratio_group=mean(DCRB_revenue,na.rm=T)/mean(trip_cost,na.rm=T)) %>% 
            # mean_relative_abun=mean(prop_remaining)) %>% 
  ungroup() %>% 
  group_by(partition) %>% 
  arrange(week) %>% 
  # cumulative profit by group across the course of the season
  mutate(cumulative_mean_profit=cumsum(mean_profit_per_trip),
         cumulative_revenue=cumsum(mean_revenue_group)) %>% 
  mutate(marginal_profit=cumulative_mean_profit-lag(cumulative_mean_profit,1),
         marginal_revenue=cumulative_revenue-lag(cumulative_revenue,1)) %>% 
  ungroup()

# Prop remaining vs. CPUE
# metrics_by_partition_week %>% 
#   ggplot(aes(mean_prop_remaining,mean_cpue,col=partition,fill=partition))+
#   geom_point(size=0.5)+
#   geom_smooth()+
#   # geom_pointrange(aes(ymin=lower,ymax=upper,),size=0.25)+
#   labs(x="Proportion Resource Remaining",y="CPUE (lbs per day)",col="Group",fill="Group")+
#   scale_color_manual(values=viridis_pal(begin=0.2,end=0.8)(4))+
#   scale_fill_manual(values=viridis_pal(begin=0.2,end=0.8)(4))

# Mean Revenue
metrics_by_partition_week %>% 
  ggplot(aes(week,mean_revenue_group,col=partition,fill=partition))+
  geom_point(size=0.5)+
  geom_smooth()+
  # geom_pointrange(aes(ymin=lower,ymax=upper,),size=0.25)+
  labs(x="Week of Season",y="Revenue per Trip",col="Group",fill="Group")+
  scale_color_manual(values=viridis_pal(begin=0.2,end=0.8)(4))+
  scale_fill_manual(values=viridis_pal(begin=0.2,end=0.8)(4))

# Mean Cost
metrics_by_partition_week %>% 
  ggplot(aes(week,mean_cost_group,col=partition,fill=partition))+
  geom_point(size=0.5)+
  geom_smooth()+
  # geom_pointrange(aes(ymin=lower,ymax=upper,),size=0.25)+
  labs(x="Week of Season",y="Cost per Trip",col="Group",fill="Group")+
  scale_color_manual(values=viridis_pal(begin=0.2,end=0.8)(4))+
  scale_fill_manual(values=viridis_pal(begin=0.2,end=0.8)(4))

# Mean profit per trip
profit_per_trip <- metrics_by_partition_week %>% 
  ggplot(aes(week,mean_profit_per_trip/1000,col=partition,fill=partition))+
  geom_point(size=0.5)+
  geom_smooth()+
  ylim(NA,40)+
  # geom_pointrange(aes(ymin=lower,ymax=upper,),size=0.25)+
  labs(x="Week of Season",y="Profit per Trip ($1000s)",col="",fill="")+
  scale_color_manual(values=viridis_pal(begin=0.2,end=0.8)(4))+
  scale_fill_manual(values=viridis_pal(begin=0.2,end=0.8)(4))+
  theme(legend.position=c(0.7,0.8))
profit_per_trip
ggsave(here::here('fishing behavior','plots','profit_per_trip.png'),profit_per_trip,w=6,h=4)

profit_per_day <- metrics_by_partition_week %>% 
  ggplot(aes(week,mean_profit_per_day/1000,col=partition,fill=partition))+
  geom_point(size=0.5)+
  geom_smooth()+
  ylim(NA,10)+xlim(0,30)+
  # geom_pointrange(aes(ymin=lower,ymax=upper,),size=0.25)+
  labs(x="Week of Season",y="Profit per Day ($1000s)",col="",fill="")+
  scale_color_manual(values=viridis_pal(begin=0.2,end=0.8)(4))+
  scale_fill_manual(values=viridis_pal(begin=0.2,end=0.8)(4))+
  theme(legend.position=c(0.7,0.8))
profit_per_day
ggsave(here::here('fishing behavior','plots','profit_per_day.png'),profit_per_day,w=6,h=4)

# Mean profit per day
metrics_by_partition_week %>% 
  ggplot(aes(week,mean_profit_per_day,col=partition,fill=partition))+
  geom_point(size=0.5)+xlim(0,25)+
  geom_smooth()+
  # geom_pointrange(aes(ymin=lower,ymax=upper,),size=0.25)+
  labs(x="Week of Season",y="Profit per Day",col="Group",fill="Group")+
  scale_color_manual(values=viridis_pal(begin=0.2,end=0.8)(4))+
  scale_fill_manual(values=viridis_pal(begin=0.2,end=0.8)(4))

# Ratio of revenue to cost
metrics_by_partition_week %>% 
  ggplot(aes(week,mean_costratio_group,col=partition,fill=partition))+
  geom_point(size=0.5)+xlim(0,25)+
  geom_smooth()+
  # geom_pointrange(aes(ymin=lower,ymax=upper,),size=0.25)+
  geom_hline(yintercept=1)+
  labs(x="Week of Season",y="Revenue/Cost Ratio",col="Group",fill="Group")+
  scale_color_manual(values=viridis_pal(begin=0.2,end=0.8)(4))+
  scale_fill_manual(values=viridis_pal(begin=0.2,end=0.8)(4))

# CPUE versus week
metrics_by_partition_week %>%
  ggplot(aes(week,mean_cpue,col=partition,fill=partition))+
  geom_point(size=0.5)+
  geom_smooth()+
  # geom_pointrange(aes(ymin=lower,ymax=upper,),size=0.25)+
  labs(x="Week",y="CPUE (lbs per day)",col="Group",fill="Group")+
  scale_color_manual(values=viridis_pal(begin=0.2,end=0.8)(4))+
  scale_fill_manual(values=viridis_pal(begin=0.2,end=0.8)(4))

```

### Season-long Revenue and Landings
  
What about total revenue gained from the Dungeness fishery over the course of the entire season?

```{r}
total_rev_landings_season <- fishtix_plus %>%
  distinct(drvid,crab_season,Rec_ID,DCRB_revenue,DCRB_lbs,trip_cost,trip_profit,partition) %>% 
  group_by(drvid,crab_season,partition) %>% 
  summarise(
    total_rev=sum(DCRB_revenue,na.rm=T),
    total_cost=sum(trip_cost,na.rm=T),
    total_land=sum(DCRB_lbs,na.rm=T),
    total_profit=sum(trip_profit,na.rm=T)) %>% 
  ungroup() %>% 
  group_by(crab_season,partition) %>% 
  summarise(n=n(),
            rev_tot=mean(total_rev,na.rm=T),
            rev_sd=sd(total_rev,na.rm=T),
            rev_se=rev_sd/n^0.5,
            cost_tot=mean(total_cost,na.rm=T),
            cost_sd=sd(total_cost,na.rm=T),
            cost_se=cost_sd/n^0.5,
            # landings in MT
            land_tot=mean(total_land,na.rm=T)/2204.64,
            land_sd=sd(total_land,na.rm=T)/2204.64,
            land_se=land_sd/n^0.5,
            profit_tot=mean(total_profit,na.rm=T),
            profit_sd=sd(total_profit,na.rm=T),
            profit_se=profit_sd/n^0.5) %>% 
  ungroup()

rev_by_group_season_plot <- total_rev_landings_season %>%
  ggplot(aes(crab_season,rev_tot,ymin=rev_tot-2*rev_se,ymax=rev_tot+2*rev_se,
             group=factor(partition),color=factor(partition)))+
  geom_line(size=1.5,position=position_dodge(width=0.2))+geom_linerange(size=1,position=position_dodge(width=0.2))+
  labs(x="Crab Season",y="Mean Total Season Revenue",title="Total Revenue by Behavior Class and Year",color="Group")+
  scale_color_manual(values=viridis_pal(begin=0.2,end=0.8)(4))+
  theme(axis.text.x = element_text(angle=90,vjust=0.5),
        legend.position = 'bottom')
rev_by_group_season_plot
# ggsave(here::here('fishing behavior','plots','revenue_by_group_season.png'),rev_by_group_season_plot,w=10,h=8)

cost_by_group_season_plot <- total_rev_landings_season %>%
  ggplot(aes(crab_season,cost_tot,ymin=cost_tot-2*cost_se,ymax=cost_tot+2*cost_se,
             group=factor(partition),color=factor(partition)))+
  geom_line(size=1.5,position=position_dodge(width=0.2))+geom_linerange(size=1,position=position_dodge(width=0.2))+
  labs(x="Crab Season",y="Mean Total Season Costs",title="Total Cost by Behavior Class and Year",color="Group")+
  scale_color_manual(values=viridis_pal(begin=0.2,end=0.8)(4))+
  theme(axis.text.x = element_text(angle=90,vjust=0.5),
        legend.position = 'bottom')
# ggsave(here::here('fishing behavior','plots','cost_by_group_season.png'),cost_by_group_season_plot,w=10,h=8)

tot_profit_season_plot <- total_rev_landings_season %>%
  filter(crab_season != "2008-2009") %>%
  mutate(profit_tot=profit_tot/1e3,profit_se=profit_se/1e3) %>% 
  ggplot(aes(crab_season,profit_tot,ymin=profit_tot-2*profit_se,ymax=profit_tot+2*profit_se,
             group=factor(partition),color=factor(partition)))+
  geom_line(size=1.5,position=position_dodge(width=0.2))+
  geom_linerange(size=1,position=position_dodge(width=0.2))+
  geom_vline(xintercept=6.5,linetype=2,col="darkred")+
  geom_vline(xintercept=9.5,linetype=2,col="darkred")+
  labs(x="Crab Season",y="Profit per Vessel ($1000s)",title="",color="Group")+
  scale_color_manual(values=viridis_pal(begin=0.2,end=0.8)(4))+
  theme(axis.text.x = element_text(angle=90,vjust=0.5,size=10),
        axis.title=element_text(family="sans",size=10,color="black"),
        axis.text.y=element_text(size=10),
        panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        legend.position = 'bottom')

tot_profit_season_plot
```

```{r,fig.height=5,fig.width=4.5}
# heatwave vs. non heatwave years
heatwave_profit <- fishtix_plus %>%
  filter(crab_season != "2008-2009") %>%
  distinct(drvid,crab_season,Rec_ID,DCRB_revenue,DCRB_lbs,trip_cost,trip_profit,partition) %>% 
  group_by(drvid,crab_season,partition) %>% 
  summarise(total_rev=sum(DCRB_revenue,na.rm=T),
    total_cost=sum(trip_cost,na.rm=T),
    total_land=sum(DCRB_lbs,na.rm=T),
    total_profit=sum(trip_profit,na.rm=T)) %>% 
  ungroup() %>%  
  mutate(is_heatwave=ifelse(crab_season %in% c('2015-2016','2016-2017','2017-2018'),"MHW","Non-MHW")) %>%
  mutate(is_heatwave=factor(is_heatwave,levels=c("Non-MHW","MHW"))) %>% 
  mutate(partition=factor(partition))

heatwave_profit_summ <- heatwave_profit %>%
  group_by(partition,is_heatwave,drvid) %>% 
  summarise(period_profit=mean(total_profit),
            period_rev=mean(total_rev),
            period_cost=mean(total_cost)) %>% 
  ungroup() %>% 
  group_by(partition,is_heatwave) %>% 
  summarise(mean_profit=mean(period_profit),
            sd_profit=sd(period_profit,na.rm=T),
            se_profit=sd_profit/sqrt(n()),
            mean_rev=mean(period_rev),
            sd_rev=sd(period_rev,na.rm=T),
            se_rev=sd_rev/sqrt(n()),
            mean_cost=mean(period_cost),
            sd_cost=sd(period_cost,na.rm=T),
            se_cost=sd_cost/sqrt(n())) %>% 
  ungroup() 

# look for significant differences between groups
mhw_profit_aov <- aov(total_profit~is_heatwave*partition,data=heatwave_profit)
summary(mhw_profit_aov)
mhw_profit_tukey <- TukeyHSD(mhw_profit_aov)$`is_heatwave:partition` %>% as_tibble(rownames = "comp")

heatwave_profit_barplot <- heatwave_profit_summ %>% 
  ggplot(aes(partition,mean_profit/1000,fill=is_heatwave))+
  scale_fill_manual(values=c("#3B4992FF","#EE0000FF"))+
  scale_color_manual(values=c("#3B4992FF","#EE0000FF"))+
  geom_col(position=position_dodge())+
  geom_errorbar(aes(partition,mean_profit/1000,group=is_heatwave,ymin=(mean_profit-2*se_profit)/1000,ymax=(mean_profit+2*se_profit)/1000),position=position_dodge(0.9),width=0.2,col="black")+
  # annotate signif diffs
  # annotate('text',label="*",size=8,x=2,y=105)+
  annotate('text',label="*",size=8,x=3,y=170)+
  annotate('text',label="*",size=8,x=4,y=180)+
  theme(panel.grid.major=element_blank(),
        panel.grid.minor=element_blank(),
        axis.title=element_text(family="sans",size=10,color="black"),
        legend.position = c(0.2,0.8),
        axis.text.x = element_text(size=10,angle=45,vjust=0.75),
        axis.text.y=element_text(size=10))+
  labs(x="Behavioral Group",y="Profit per Vessel ($1000s)",fill="Period")
heatwave_profit_barplot
ggsave(here('fishing behavior','plots','heatwave_profit_barplot.png'),w=6,h=6)

# revenue
heatwave_rev_barplot <- heatwave_profit_summ %>% 
  ggplot(aes(partition,mean_rev/1000,fill=is_heatwave))+
  scale_fill_manual(values=c("#3B4992FF","#EE0000FF"))+
  scale_color_manual(values=c("#3B4992FF","#EE0000FF"))+
  geom_col(position=position_dodge())+
  geom_errorbar(aes(partition,mean_rev/1000,group=is_heatwave,ymin=(mean_rev-2*se_rev)/1000,ymax=(mean_rev+2*se_rev)/1000),position=position_dodge(0.9),width=0.2,col="black")+
  theme(panel.grid.major=element_blank(),
        panel.grid.minor=element_blank(),
        axis.title=element_text(family="sans",size=14,color="black"),
        legend.position = c(0.2,0.8),
        axis.text.x = element_text(angle=45,vjust=0.75))+
  labs(x="Behavioral Group",y="Revenue per Vessel ($1000s)",fill="Period")
heatwave_rev_barplot
#cost
heatwave_cost_barplot <- heatwave_profit_summ %>% 
  ggplot(aes(partition,mean_cost/1000,fill=is_heatwave))+
  scale_fill_manual(values=c("#3B4992FF","#EE0000FF"))+
  scale_color_manual(values=c("#3B4992FF","#EE0000FF"))+
  geom_col(position=position_dodge())+
  geom_errorbar(aes(partition,mean_cost/1000,group=is_heatwave,ymin=(mean_cost-2*se_cost)/1000,ymax=(mean_cost+2*se_cost)/1000),position=position_dodge(0.9),width=0.2,col="black")+
  theme(panel.grid.major=element_blank(),
        panel.grid.minor=element_blank(),
        axis.title=element_text(family="sans",size=14,color="black"),
        legend.position = c(0.2,0.8),
        axis.text.x = element_text(angle=45,vjust=0.75))+
  labs(x="Behavioral Group",y="Cost per Vessel ($1000s)",fill="Period")
heatwave_cost_barplot

# grid with a few plots
# row2 <- plot_grid(heatwave_profit_barplot, profit_per_day, labels = c('b', 'c'), label_size = 12)

ts_heatwave_profit_plot <- plot_grid(tot_profit_season_plot, heatwave_profit_barplot, labels = c('a', 'b'), label_size = 12, ncol = 1)
ts_heatwave_profit_plot
# ggsave(here::here('fishing behavior','plots','timeseries_and_heatwave_profits.png'),ts_heatwave_profit_plot,w=8,h=10)
# ggsave(here::here('fishing behavior','plots','timeseries_and_heatwave_profits.pdf'),ts_heatwave_profit_plot,w=8,h=10)
```


### Non-Dungeness Revenue

We want to look at patterns in revenue gained outside of the Dungeness fishery by these same vessels.

```{r}
# calculate non-DCRB revenue by week
drvid_dcrb_other <- fishtix_long %>% 
  filter(drvid %in% unique(dat_clustered$drvid)) %>%
  # add week of season
  mutate(timediff=start_of_season_oneperc%--%date) %>% 
  mutate(week=time_length(timediff,'weeks')) %>% 
  mutate(week=floor(week)) %>% 
  dplyr::select(-timediff,-start_of_season_oneperc) %>%
  ungroup() %>%
  # filter for in-season weeks
  filter(week>=0) %>% 
  distinct() %>% 
  # calculate DCRB vs. non-DCRB revenue
  mutate(is_DCRB=PACFIN_SPECIES_CODE=="DCRB") %>% 
  group_by(Rec_ID,drvid,crab_season,week) %>% 
  summarise(DCRB_revenue=sum(spp_revenue[is_DCRB]),other_revenue=sum(spp_revenue[!is_DCRB])) %>% 
  ungroup() %>% 
  mutate(DCRB_revenue=coalesce(DCRB_revenue,0),other_revenue=coalesce(other_revenue,0)) %>% 
  group_by(drvid,crab_season,week) %>% 
  summarise(tot_dcrb_revenue=sum(DCRB_revenue),tot_other_revenue=sum(other_revenue)) %>% 
  ungroup() %>% 
  mutate(prop_dcrb_revenue=tot_dcrb_revenue/(tot_dcrb_revenue+tot_other_revenue)) %>% 
  # join cluster group/partition information
  left_join(drvid_group_key) %>% 
  filter(!is.na(partition)) %>% 
  mutate(tot_revenue_allsources=tot_dcrb_revenue+tot_other_revenue)

perc_revenue_heatwave <- drvid_dcrb_other %>% 
  mutate(is_heatwave=ifelse(crab_season %in% c('2015-2016','2016-2017','2017-2018'),"MHW","Non-MHW")) %>%
  mutate(is_heatwave=factor(is_heatwave,levels=c("Non-MHW","MHW"))) %>% 
  mutate(perc_dcrb=tot_dcrb_revenue/tot_revenue_allsources,perc_other=tot_other_revenue/tot_revenue_allsources) %>% 
  group_by(partition,week,is_heatwave)%>% 
  summarise(Dungeness=mean(perc_dcrb,na.rm=T),Other=mean(perc_other,na.rm=T)) %>% 
  ungroup()

perc_revenue_heatwave_plot <- perc_revenue_heatwave %>% 
  ggplot(aes(week,Dungeness*100,col=partition,linetype=is_heatwave))+
  geom_line(size=1.5)+
  coord_cartesian(xlim=c(0,45),ylim=c(0,100),expand=F)+
  scale_color_manual(values=viridis_pal(begin=0.2,end=0.8)(4))+
  labs(x="Week of Season",y="Percent of Weekly Revenue",col="Group",linetype="Period")+
  # facet_wrap(~is_heatwave,nrow=1)+
  theme(panel.grid.major=element_blank(),
        panel.grid.minor=element_blank(),
        panel.border=element_rect(fill=NA),
        legend.text=element_text(size=10))

perc_revenue_heatwave_plot
perc_revenue_heatwave_plot+geom_hline(yintercept = 80)+geom_vline(xintercept=22)

# with dotted heatwave lines
ggsave(here::here('fishing behavior','plots','dcrb_perc_revenue_by_week_heatwave.png'),perc_revenue_heatwave_plot,w=8,h=6)
```

```{r}
# Other revenue MHW vs. non-MHW years
other_rev <- drvid_dcrb_other %>% 
  mutate(is_heatwave=ifelse(crab_season %in% c('2015-2016','2016-2017','2017-2018'),"MHW","Non-MHW")) %>%
  mutate(is_heatwave=factor(is_heatwave,levels=c("Non-MHW","MHW"))) %>%
  group_by(drvid,crab_season,is_heatwave,partition) %>% 
  summarise(r=sum(tot_other_revenue,na.rm=T)) %>% 
  ungroup() %>% 
  group_by(crab_season,is_heatwave,partition) %>%
  # group_by(crab_season,partition) %>% 
  summarise(n=n(),
            rev_tot=mean(r,na.rm=T),
            rev_sd=sd(r,na.rm=T),
            rev_se=rev_sd/n^0.5)
other_rev_season <- other_rev %>% 
  ggplot(aes(crab_season,rev_tot/1e3,group=partition,col=partition))+
  geom_line(size=2)+
  geom_vline(xintercept=7.5,linetype=2,col="darkred")+
  geom_vline(xintercept=10.5,linetype=2,col="darkred")+
  geom_errorbar(aes(ymin=(rev_tot-2*rev_se)/1e3,ymax=(rev_tot+2*rev_se)/1e3),width=0.2)+
  labs(x="Crab Season",y="Non-Dungeness Revenue ($1000s)",col="Group")+
  scale_color_manual(values=viridis_pal(begin=0.2,end=0.8)(4))+
  scale_fill_manual(values=viridis_pal(begin=0.2,end=0.8)(4))+
  theme(axis.text.x = element_text(size=10,angle=90,vjust=0.5),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      legend.text = element_text(size=8),
      axis.text.y=element_text(size=10),
      axis.title.x=element_text(size=10),
      axis.title.y=element_text(size=10),
      legend.position = 'bottom')
other_rev_season
# ggsave(here::here('fishing behavior','plots','outside_revenue_by_season_group.png'),other_rev_season,w=8,h=6)
```

MHW vs. non-MHW years, with significance testing

```{r}
# bar plots of heatwave vs. non-heatwave years
# heatwave vs. non heatwave years
# estimate statistical signif
mhw_outside_revenue <- drvid_dcrb_other %>% 
  mutate(is_heatwave=ifelse(crab_season %in% c('2015-2016','2016-2017','2017-2018'),"MHW","Non-MHW")) %>%
  mutate(is_heatwave=factor(is_heatwave,levels=c("Non-MHW","MHW"))) %>%
  group_by(drvid,crab_season,is_heatwave,partition) %>% 
  summarise(r=sum(tot_other_revenue,na.rm=T)) %>% 
  ungroup()
```

```{r}
mhw_outside_revenue_aov <- aov(r~is_heatwave*partition,data=mhw_outside_revenue)
summary(mhw_outside_revenue_aov)
# look for significant differences between groups
mhw_outside_revenue_tukey <- TukeyHSD(mhw_outside_revenue_aov)$`is_heatwave:partition` %>% as_tibble(rownames = "comp")
```

```{r,fig.width=4.5,fig.height=5}
heatwave_non_dcrb_barplot <- mhw_outside_revenue %>%  
  group_by(is_heatwave,partition) %>%
  # group_by(crab_season,partition) %>% 
  summarise(n=n(),
            rev_tot=mean(r,na.rm=T),
            rev_sd=sd(r,na.rm=T),
            rev_se=rev_sd/n^0.5) %>% 
  ggplot(aes(partition,rev_tot/1000,fill=is_heatwave,col=is_heatwave))+
  scale_fill_manual(values=c("#3B4992FF","#EE0000FF"))+
  scale_color_manual(values=c("#3B4992FF","#EE0000FF"))+
  geom_col(position=position_dodge())+
  geom_errorbar(aes(partition,rev_tot/1000,group=is_heatwave,ymin=(rev_tot-2*rev_se)/1000,ymax=(rev_tot+2*rev_se)/1000),position=position_dodge(0.9),width=0.2,color='black')+
  theme(panel.grid.major=element_blank(),
        panel.grid.minor=element_blank(),
        axis.title=element_text(family="sans",size=10,color="black"),
        legend.position = c(0.2,0.8),
        axis.text.x = element_text(size=10,angle=45,vjust=0.75))+
  # manually annotate signif diffs
  annotate("text",x=2,y=425,label="*",size=8)+
  annotate("text",x=3,y=250,label="*",size=8)+
  annotate("text",x=4,y=1000,label="*",size=8)+
  labs(x="Behavioral Group",y="Non-Dungeness Revenue ($1000s)",fill="Period",col="Period")
heatwave_non_dcrb_barplot
ggsave(here::here('fishing behavior','plots','heatwave_non_dcrb_revenue.png'),heatwave_non_dcrb_barplot,w=5,h=5)

other_revenue_season_heatwave <- plot_grid(other_rev_season, heatwave_non_dcrb_barplot,labels = "auto",nrow = 2)
other_revenue_season_heatwave
# ggsave(here::here('fishing behavior','plots','non_dcrb_seasons_groups_revenue.png'),other_revenue_season_heatwave,w=6,h=8)
# ggsave(here::here('fishing behavior','plots','non_dcrb_seasons_groups_revenue.pdf'),other_revenue_season_heatwave,w=6,h=8)
```
```{r}
all_fishtix_spp <- fishtix_long %>%
  filter(drvid %in% vessel_list) %>%
  distinct(PACFIN_SPECIES_CODE) %>% 
  # join the PACFIN-recognized species groups, and use this to organize
  left_join(pacfin_spid,by=c('PACFIN_SPECIES_CODE'='SPID')) %>% 
  dplyr::select(PACFIN_SPECIES_CODE,`Common Name`, Grp) %>% 
  rename(commonname=`Common Name`,spp_grp=Grp) %>% 
  mutate(commonname=tools::toTitleCase(tolower(commonname)))

# other species caught by Dcrab groups
other_fisheries_revenue_partitions <- fishtix_long %>%
  filter(drvid %in% vessel_list) %>%
  left_join(drvid_group_key) %>% 
  distinct(Rec_ID,drvid,partition,crab_season,PACFIN_SPECIES_CODE,tot_revenue_spp) %>%
  left_join(all_fishtix_spp) %>% 
  group_by(partition,crab_season,spp_grp) %>%  
  summarise(tot_rev=sum(tot_revenue_spp,na.rm=T)) %>% 
  ungroup() %>% 
  drop_na() %>% 
  filter(spp_grp!='CRAB') %>% 
  arrange(partition,spp_grp,crab_season)

outside_revenue_sppgroups_ts <- other_fisheries_revenue_partitions %>% 
  ggplot(aes(factor(crab_season),tot_rev,group=spp_grp,fill=spp_grp))+
  # geom_point()+geom_line()+
  geom_col()+
  scale_fill_manual(values=viridis_pal(begin=0.2,end=0.8)(6))+
  # facet_wrap(~spp_grp)+
  facet_wrap(~partition)+
  labs(x='Crab Season',y="Total Revenue",col="Group")+
  theme(axis.text.x = element_text(angle=90,vjust=0.5),
        legend.position = 'bottom')
outside_revenue_sppgroups_ts
ggsave(here::here('fishing behavior','plots','otherspp_revenue_ts.pdf'),outside_revenue_sppgroups_ts,w=8,h=6)
# ggsave(here::here('fishing behavior','plots','otherspp_revenue_ts.png'),outside_revenue_sppgroups_ts,w=8,h=6)
```
Bar plots by group of proportional revenue by outside species group
```{r}
other_fisheries_revenues_grp <- fishtix_long %>%
  filter(drvid %in% vessel_list) %>%
  # first 100 days of the season
  filter(ticket_day_of_season<=120) %>% 
  left_join(drvid_group_key) %>% 
  distinct(Rec_ID,drvid,crab_season,partition,PACFIN_SPECIES_CODE,tot_revenue_spp) %>%
  left_join(all_fishtix_spp) %>% 
  group_by(drvid,crab_season,partition,spp_grp) %>%  
  summarise(tot_rev=sum(tot_revenue_spp,na.rm=T)) %>% 
  ungroup() %>% 
  complete(nesting(drvid,crab_season),spp_grp,fill=list(tot_rev=0)) %>% 
  ungroup() %>% 
  group_by(drvid,crab_season,partition) %>% 
  mutate(prop_rev=tot_rev/sum(tot_rev)) %>%
  mutate(is_heatwave=ifelse(crab_season %in% c('2015-2016','2016-2017','2017-2018'),"MHW","Non-MHW")) %>%
  mutate(is_heatwave=factor(is_heatwave,levels=c("Non-MHW","MHW"))) %>%
  ungroup() %>% 
  group_by(partition,is_heatwave,spp_grp) %>% 
  summarise(mean_prop_rev=mean(prop_rev,na.rm=T)) %>% 
  ungroup() %>% 
  drop_na()

# other_fisheries_changes <- other_fisheries_revenues_grp %>% 
#   group_by(partition,spp_grp) %>% 
#   summarise(mhwdiff=mean_prop_rev[is_heatwave=="MHW"]-mean_prop_rev[is_heatwave=="Non-MHW"]) %>% 
#   mutate(mhwdiff=mhwdiff*100)

other_fisheries_revenues_spp_grps_plot <- other_fisheries_revenues_grp %>% 
  drop_na() %>% 
  arrange(desc(mean_prop_rev)) %>% 
  ggplot(aes(x=fct_reorder(spp_grp,-mean_prop_rev),y=mean_prop_rev*100,fill=partition))+
  geom_col(position='dodge')+
  facet_wrap(~is_heatwave,nrow=2)+
  scale_fill_manual(values=p)+
  theme(panel.grid.major=element_blank(),panel.grid.minor=element_blank(),
        axis.text.x=element_text(angle = 90,vjust=0))+
  scale_y_continuous(breaks=seq(0,100,by=20),limits=c(0,100))+
  labs(x="Species Group Code",y="Mean Percent of Revenue",fill="Group",title="Species Groups by Proportion of Revenue\nFirst 120 Days of Crab Season")

other_fisheries_revenues_spp_grps_plot

ggsave(here::here('fishing behavior','plots','outside_fisheries_revenue_by_group_and_spp.png'),other_fisheries_revenues_spp_grps_plot,w=6,h=8)

```


## Homerange Size

```{r}
# home range size over time
homeranges_ts <- dat %>% 
  select(drvid,crab_season,homerange) %>% 
  left_join(dat_clustered %>% select(drvid,crab_season,partition)) %>% 
  left_join(homeports,by=c('drvid','crab_season')) %>% 
  filter(!is.na(partition)) %>% 
  # mutate(is_heatwave=ifelse(crab_season %in% c('2015-2016','2016-2017','2017-2018'),"MHW","Non-MHW")) %>%
  # mutate(is_heatwave=factor(is_heatwave,levels=c("Non-MHW","MHW"))) %>% 
  group_by(partition,crab_season) %>% 
  summarise(homerange_area=mean(homerange),sd_homerange=sd(homerange,na.rm=T),se_homerange=sd_homerange/sqrt(n()))

homeranges_by_season <- homeranges_ts %>% 
  ggplot(aes(crab_season,homerange_area,group=partition,col=partition))+
  geom_line(size=2)+
  geom_vline(xintercept=7.5,linetype=2,col="darkred")+
  geom_vline(xintercept=10.5,linetype=2,col="darkred")+
  geom_errorbar(aes(ymin=(homerange_area-2*se_homerange),ymax=(homerange_area+2*se_homerange)),width=0.1,
                position=position_dodge(width=0.1))+
  labs(x="Crab Season",y="Home Range Area (square km)",col="Group")+
  scale_color_manual(values=viridis_pal(begin=0.2,end=0.8)(4))+
  scale_fill_manual(values=viridis_pal(begin=0.2,end=0.8)(4))+
  theme(axis.text.x = element_text(size=10,angle=90,vjust=0.5),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      legend.text = element_text(size=8),
      legend.position = 'bottom',
      axis.title=element_text(size=10))
homeranges_by_season
# ggsave(here::here('fishing behavior','plots','outside_revenue_by_season_group.png'),other_rev_season,w=8,h=6)
```

```{r}
# did home ranges change in MHW?
mhw_homeranges <- dat %>% 
  select(drvid,crab_season,homerange) %>% 
  left_join(dat_clustered %>% select(drvid,crab_season,partition)) %>% 
  left_join(homeports,by=c('drvid','crab_season')) %>% 
  filter(!is.na(partition)) %>% 
  mutate(is_heatwave=ifelse(crab_season %in% c('2015-2016','2016-2017','2017-2018'),"MHW","Non-MHW")) %>%
  mutate(is_heatwave=factor(is_heatwave,levels=c("Non-MHW","MHW"))) 

mhw_homeranges_summ <- mhw_homeranges %>% 
  group_by(partition,is_heatwave) %>% 
  summarise(homerange_area=mean(homerange),sd_homerange=sd(homerange,na.rm=T),se_homerange=sd_homerange/sqrt(n()))
```

```{r}
mhw_homerange_aov <- aov(homerange~is_heatwave*partition,data=mhw_homeranges)
summary(mhw_homerange_aov)
# look for significant differences between groups
mhw_homerange_tukey <- TukeyHSD(mhw_homerange_aov)$`is_heatwave:partition` %>% as_tibble(rownames = "comp")
```

```{r, fig.width=4.5, fig.height=5}
mhw_homeranges_plot <-mhw_homeranges_summ %>% 
  ggplot(aes(partition,homerange_area,fill=is_heatwave,col=is_heatwave))+
  scale_fill_manual(values=c("#3B4992FF","#EE0000FF"))+
  scale_color_manual(values=c("#3B4992FF","#EE0000FF"))+
  geom_col(position=position_dodge())+
  geom_errorbar(aes(partition,homerange_area,group=is_heatwave,ymin=(homerange_area-2*se_homerange),ymax=homerange_area+2*se_homerange),position=position_dodge(0.9),width=0.2,col="black")+
  # facet_wrap(~agency_code,nrow=3,scales="free_y")+
  labs(y="Home Range Area (square km)",fill="Period",col="Period",x="Behavioral Group")+
  annotate("text",label="*",x=3,y=6300,size=8)+
  annotate("text",label="*",x=4,y=5700,size=8)+
  theme(panel.grid.major=element_blank(),
        panel.grid.minor=element_blank(),
        legend.position = c(0.2,0.8),
        axis.text.x=element_text(angle=45,vjust=0.75,size=10),
        axis.text.y=element_text(size=10),
        axis.title=element_text(family="sans",size=10,color="black"))
        # legend.position = c(0.2,0.8),
        # axis.text.x = element_text(angle=45,vjust=0.75),)
mhw_homeranges_plot
ggsave(here('fishing behavior','plots','heatwave_homerange_barplot.png'),w=6,h=6)
```

```{r}
homerange_season_heatwave <- plot_grid(homeranges_by_season, mhw_homeranges_plot,labels = "auto",nrow = 2)
homerange_season_heatwave
ggsave(here::here('fishing behavior','plots','homerange_season_heatwave.png'),homerange_season_heatwave,w=6,h=8)
ggsave(here::here('fishing behavior','plots','homerange_season_heatwave.pdf'),homerange_season_heatwave,w=6,h=8)
```

## Group Differences Plot

Simple multipanel figure showing the spatial and revenue differences (not including MHW dynamic)

```{r}
perc_revenue <- drvid_dcrb_other %>%
  mutate(perc_dcrb=tot_dcrb_revenue/tot_revenue_allsources,perc_other=tot_other_revenue/tot_revenue_allsources) %>% 
  group_by(partition,week)%>% 
  summarise(Dungeness=mean(perc_dcrb,na.rm=T),Other=mean(perc_other,na.rm=T)) %>% 
  ungroup() %>% 
  mutate(market_type=ifelse(grepl("Specialist",partition),"Specialist","Generalist") %>% as.factor())

override.linetype=c(3,1,3,1)
override.color=viridis_pal(begin=0.2,end=0.8)(4)
override.fill=viridis_pal(begin=0.2,end=0.8)(4)

perc_revenue_plot <- perc_revenue %>% 
  # filter(market_type != "Specialist") %>%
  ggplot(aes(week,Dungeness*100,col=partition,linetype=market_type,fill=partition))+
  geom_line(size=1.5)+
  # geom_col()+
  coord_cartesian(xlim=c(0,45),ylim=c(0,100),expand=F)+
  scale_color_manual(values=viridis_pal(begin=0.2,end=0.8)(4))+
  # scale_fill_manual(values=viridis_pal(begin=0.2,end=0.8)(4))+
  scale_linetype_manual(values=c(1,2))+
  labs(x="Week of Season",y="Percent Revenue from Dungeness Fishery")+
  guides(color = guide_legend("Group",override.aes = list(color=override.color, linetype = override.linetype,
                               fill=override.fill),nrow=2,byrow=T,size=2),
         linetype='none',fill='none')+
  # facet_wrap(~is_heatwave,nrow=1)+
  # guides(fill=guide_legend("Group"),color='none',linetype='none')+
  theme(panel.grid.major=element_blank(),
        panel.grid.minor=element_blank(),
        panel.border=element_rect(fill=NA),
        legend.text=element_text(size=10),
        axis.title.y=element_text(size=14),
        axis.text.x = element_text(size=12),
        axis.text.y= element_text(size=12),
        axis.title.x=element_text(size=14),
        legend.title = element_text(size=10,face='bold'),
        legend.position = 'none')
perc_revenue_plot
ggsave(here::here('fishing behavior','plots','dcrb_perc_revenue_by_week.png'),perc_revenue_plot,w=8,h=6)
```

Look at the spatial footprints by season for vessels in different groups. We look at the total convex hulls (spatial footprint) for vessels out of specific ports (defined as the most common landing port in a season), in different behavioral groups.

```{r}
vms_groups <- vms_all_grd %>% 
  left_join(dat_clustered,by=c('drvid','crab_season')) %>% 
  filter(!is.na(partition)) %>% 
  mutate(is_heatwave=ifelse(crab_season %in% c('2015-2016','2016-2017','2017-2018'),"MHW","Non-MHW"))

# define home ports as most commonly-landed port for each vessel in each year
homeports <- fishtix %>% 
  group_by(drvid,crab_season,agency_code) %>% 
  count(port_group_code) %>% 
  top_n(1,n) %>% 
  rename(homeport=port_group_code) %>%
  select(-n)

# join homeports to vms data
vms_groups %<>%
  left_join(homeports,by=c('drvid','crab_season','agency_code'))
```

How do we average home ranges across groups?
We'll take the approach of the 95th percentile of lat and lon for vessels in each home port and behavioral group.

```{r}
# library(RANN)
states_all <- coaststates %>% summarise()
find_hull <- function(df,tol=0.98){
  dsts <- RANN::nn2(df %>% as_tibble() %>% select(X_COORD,Y_COORD),k=min(100,nrow(df)))$nn.dists %>% rowMeans()
  hull<-df %>%
    mutate(meandist=dsts) %>%
    # remove top 5% spatial outliers based on distance from other points
    mutate(rnk=percent_rank(dsts)) %>%
    filter(rnk<tol) %>%
    ungroup() %>%
    summarise() %>%
    st_convex_hull()%>%
    st_difference(states_all)
  return(hull)
}
```

```{r}
# Newport average footprints, but with no MHW modifier
newport <- vms_groups %>%
  filter(homeport=="NPA") %>%
  # group by behavioral group and home port and calculate hulls
  # st_as_sf(coords=c("X_COORD","Y_COORD"))
  group_by(partition) %>%
  nest() %>%
  mutate(cvxhull=purrr::map(data,find_hull,tol=0.95)) %>% 
  ungroup()

footprints_newport <- newport %>%
  pluck("cvxhull") %>%
  bind_rows()

footprints_newport <- newport %>%
  select(-data,-cvxhull) %>%
  bind_cols(footprints_newport) %>%
  st_as_sf() %>% 
  mutate(a=st_area(geometry)/1e6 %>% as.numeric())
#
# library(ggforce)
bbox <- st_bbox(footprints_newport)
newport_total_footprints <- footprints_newport %>% 
  mutate(pltgrp=factor(partition,levels=c("Roving Generalists","Roving Specialists","Local Generalists","Local Specialists"))) %>%
  ggplot()+
  geom_sf(aes(fill=pltgrp),alpha=0.8,col=NA)+
  geom_sf(data=coaststates)+
  scale_fill_manual(values=rev(viridis_pal(begin=0.2,end=0.8)(4)))+
  coord_sf(xlim=c(bbox[1],bbox[3]),ylim=c(bbox[2],bbox[4]),datum=NA)+
  guides(fill=guide_legend("Behavioral Cluster",nrow=2,byrow=T))
  # theme(legend.position=c(0.8,0.8))
newport_total_footprints

#find newport port loc
nwprt_coords <- vms_groups %>% filter(in_port=="NEW") %>% st_coordinates() %>% 
  apply(2,mean)

newport_total_footprints2 <- newport_total_footprints+annotate(geom="point",x=nwprt_coords[1],y=nwprt_coords[2],size=2)+
  theme(legend.position = 'none')+
  theme(axis.title.x = element_blank(),axis.title.y=element_blank())+
  theme(panel.border = element_rect(color="black",fill=NA))

fill_leg <- get_legend(newport_total_footprints)
p1 <- plot_grid(perc_revenue_plot,fill_leg,ncol=1,rel_heights = c(5,1))
p2 <- plot_grid(newport_total_footprints2,NULL,p1,nrow=1,labels=c('a','','b'),rel_widths = c(1,-0.2,2))
groups_mobility_flexibility_plot <- plot_grid(newport_total_footprints,perc_revenue_plot,fill_leg,nrow=1,rel_widths = c(1,3),rel_heights=c(1,1),labels = 'auto')
groups_mobility_flexibility_plot
p2

ggsave(here::here('fishing behavior','plots','groups_mobility_flexibility.png'),p2,w=7.5,h=6)
ggsave(here::here('fishing behavior','plots','groups_mobility_flexibility.pdf'),p2,w=7.5,h=6)
```