---
title: "VMS Main Text Figures"
author: "M Fisher"
date: "2023-03-07"
output: html_document
---
## Description

Create figures for main text.

Notes on data decisions for these figures: 

- for vessel groups, if a given Local vessel changed size classes over the course of the study period, it was allowed to switch size-based groups (e.g., large v. small Local) but was kept in the same district-based group (e.g., Local Central v. Local Northern). this only included one vessel.

- for vessel group # 3, one vessel was included as a 'large' vessel even though it was 39ft in length to maximize data retention for this district-based group

<br>

**Figure 1:** cumulative landings by central / northern district for all study years

  - Supplement: same graph for each vessel group

**Figure 2:** Which vessels exhibit the greatest mobility?

  - Compare year-over-year Earth Mover's Distance for all large and small vessels
  - Compare year-over-year Earth Mover's Distance for vessel groups 

**Figure 3:** Map gridded fishing activity. see `figures_map_grid_activity.Rmd`

**Figures 4 - 5:** How does overlap between vessel groups change?

  - Compare year-over-year BA overlap between vessel groups (at varying timescales)
  - Compare resampled year-over-year BA overlap between vessel groups
  
    
**Figure X:** Map the utilization distributions from each vessel group **Replaced by gridded activity, Figure 3.**

  - Small Local vessel groups
  - Large Local vessel groups
  - Cross-district pool (Coastwide + Mobile Northern)


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)


library(tidyverse)
library(magrittr)
library(here)
# library(raster)
library(adehabitatHR)
# library(move)
library(pryr)
library(vegan)
library(cowplot)
library(plotrix)
library(janitor)
library(PNWColors)

library(maps)
# library(rgdal)
# library(rgeos)
library(grid); library(gridExtra)

source(here('R','getmode.R'))
source(here('R/map_fishing_stacked_2sizes.R'))
source(here('R','map_fishing_stacked.R'))

std.error=function(x) sd(x)/sqrt(length(x))
```

User inputs
```{r}
keep_years <- seq(2013,2018)
statdir    <- here('project-dat','statistics')
uddir      <- here('project-dat','vms','interpolation_60min','NaN_speed_filter','group90ud')
metadir    <- here('project-dat')

nboots   <- 1000  # re-sampling parameter
k        <- 5   # number of clusters

## save figures / intermediate data files?
writing  <- TRUE

## change the resolution of the map figure
png_res  <-  200 # suggested:200
## offset of each coastline from the others; this should change with res
offset   <- 2.5  # suggested:2.5
## size of port group labels on maps; this should change with res
pg_label_size <- 4  # suggested:4
```


## Data

port group points
```{r}
pg <- read.csv(here::here(metadir,'pcgroup_mean_coordinates.csv'))
coordinates(pg) <- c("Lon", "Lat")
proj4string(pg) <- CRS("+init=epsg:4326") # WGS 84
pg_df <- as.data.frame(pg)
```

season start dates
```{r}
season_dates_df <- read_csv(here::here(metadir,"dcrb_season_starts.csv")) %>%
  mutate(season_start_date=mdy(season_start_date),
         season_end_date=ifelse(pcdistrict=="northern",paste0("7/15/",crab_year),
                                paste0("6/30/",crab_year))) %>%
  mutate(season_end_date=mdy(season_end_date))
```


Vessel length keys
```{r}
vlengths <- read_csv(here('project-dat','vessel_groups','length_key_dcrb_vms_vessels.csv'))
```

Clustering groups
```{r}
vgroups <- read_csv(here('project-dat','vessel_groups','k5b_NaNspeedfilter_2014clusterYR_byArea_noncon-group-key.csv'))

vgroup_summary <- vgroups %>% dplyr::select(group,subgroup,group_area, vessel_size) %>% distinct()
vgroup_annual_summary <- vgroups %>% dplyr::select(subgroup,group_area,vessel_size,crab_year) %>% 
  distinct() %>% arrange(subgroup)
```


Earth mover's distance (by vessel)
```{r}
emd.dat <- read_csv(here(statdir,'EMD_annual_per_vessel_90ud_75grid_2011-18crabYrs.csv'))
```

Earth mover's distance (means)
```{r}
emd_means <- read_csv(here(statdir,'meanEMD_annual_bysize_90ud_75grid.csv'))
emd_group_means_noncon <- read_csv(here(statdir,'meanEMD_annual_bygroup_90ud_75grid_k5_2014clusterYR_noncon.csv'))
```


Earth mover's distance (significance testing)
```{r}
load(here('project-dat','statistics','wilcox_tests_bylength.rdata'))
wilcox.lengths <- wilcox_tests_bylength[[2]]
sig.lengths <- wilcox_tests_bylength[[3]]
```
```{r}
wilcox_tests_localbylength <- readRDS(here('project-dat','statistics','wilcox_tests_2014groupsk5_LocalBYlength_noncon.rds'))
wilcox.locals <- wilcox_tests_localbylength[[2]]
sig.locals <- wilcox_tests_localbylength[[3]]
```



BA index (bootstrapped across clusters)
```{r}
ba.boot.df <- read_csv(here(statdir,paste0('BAoverlap_bootstrappedPROJ6_',keep_years[1],"-",substr(last(keep_years),3,4),'_annual.csv'))) %>%
  mutate(timeframe="annual") %>%
  bind_rows(read_csv(here(statdir,paste0('BAoverlap_bootstrappedPROJ6_',keep_years[1],"-",substr(last(keep_years),3,4),'_central.csv'))) %>%
  mutate(timeframe="central")) %>%
  bind_rows(read_csv(here(statdir,paste0('BAoverlap_bootstrappedPROJ6_',keep_years[1],"-",substr(last(keep_years),3,4),'_northern.csv'))) %>%
  mutate(timeframe="northern"))
```

BA index (by cluster)
```{r eval=FALSE}
ba <- read_csv(here('project-dat','statistics','BAoverlap_rawPairwise_2013-18crabYrs_noncon-tix.csv'))

# Add vessel group info to the BA index dataframe

ba %<>% left_join(vgroup_summary %>% dplyr::select(-group),by=c("group1"="subgroup")) %>%
  rename(group1_area=group_area,group1_size=vessel_size) %>%
  left_join(vgroup_summary %>% dplyr::select(-group),by=c("group2"="subgroup")) %>%
  rename(group2_area=group_area,group2_size=vessel_size)
```


90% Utilization Distributions, as rasters, saved into a list of lists. A list of rasters (by year) was saved for each vessel group from script `04b_vessel_group_overlap.Rmd`
```{r}
udlist <- list()
for(i in seq(1,length(vgroup_summary$subgroup))){
  g <- vgroup_summary$subgroup[i]
  tmpuds <- readRDS(here(uddir,paste0(g,"_90ud_SpatialPolygonsGetVerticesHR_250grid_2013-18crabYrs_annual.rds")))
  udlist[[i]] <- tmpuds
}

names(udlist) <- vgroup_summary$subgroup



udlist2 <- list()
for(i in c(2,4)){
  g <- vgroup_summary$subgroup[i]
  print(g)
  tmpuds <- readRDS(here(uddir,paste0(g,"_90ud_SpatialPolygonsGetVerticesHR_250grid_2013-18crabYrs_annual_QCsub.rds")))
  udlist2[[i]] <- tmpuds
}

names(udlist2) <- vgroup_summary$subgroup[c(2,4)]

udlist2[[1]] <- vms_udp
```
<br>


## Figure 1

Read in fish tickets:
```{r read_fishtix}
for(y in c(keep_years, (last(keep_years)+1))){
  tmpy <- y-1
  tmptix <-  read_rds(here::here('../data','processed','fish tickets',paste0(tmpy,'fishtix_vlengths.rds')))
  if(y==(keep_years[1])){
    tix <- tmptix
  } else{
    tix %<>% bind_rows(tmptix)
  }
}

## add crab year, day of season, filter for ca commercial Dungeness crab landings
tix %<>% filter(agency_code == "C") %>%
  filter(TARGET_lbs == "DCRB") %>%
  filter(removal_type_code=="C" | removal_type_code=="D" | removal_type_code=="U") %>%
  # grab subset of columns
  dplyr::select(Rec_ID,date, month, year, drvid, pacfin_port_code, port_group_code, agency_code, 
                removal_type_code, removal_type_name, TARGET_lbs,
                DCRB_lbs,DCRB_revenue,
                FINAL_LENGTH) %>%
  # add on crab season based on month of year, and filter
  # mutate(date=as_date(date, c("ymd","mdy")),
  #        year=year(date)) %>%
  mutate(year=year(date)) %>%
  mutate(crab_season=case_when(
    month(date)>10 ~ paste0(year,"-",year+1),
    month(date)<=10 ~ paste0(year-1,"-",year)),
    crab_year=case_when(
      month(date)>10 ~ year+1,
      month(date)<=10 ~ year)) %>%
  filter(crab_year %in% keep_years)
```

Remove the out-of-season landings, add the week of season
```{r}
tix %<>% mutate(region=ifelse(port_group_code %in% c("CCA","ERA","BGA"),"northern",
                       ifelse(port_group_code %in% c("BDA","SFA","MNA","MRA"), "central", NA)),
         woy=isoweek(date)) %>%
  left_join(season_dates_df,by=c("crab_year","region"="pcdistrict"))

subtix <- tix %>% filter(!is.na(region) & crab_year %in% keep_years) %>%
  filter(difftime(season_end_date,date,units='days') >= 0) %>%
  filter(!is.na(season_start_date)) %>%
  mutate(wos=difftime(date,season_start_date,'weeks')) %>% 
  mutate(wos=floor(wos)) %>%
  filter(wos>=0)
```

Get the cumulative sum of Dungeness crab landings by day of year
```{r}
subtix$woy <- factor(subtix$woy, levels=c(seq(46,53),seq(1,45)))
                          
weekly_dcrb <- subtix %>%
  group_by(region,crab_year,woy) %>% 
  summarise(weekly_DCRB_lbs=sum(DCRB_lbs)) %>%
  group_by(region,crab_year) %>%
  arrange(woy) %>%
  mutate(cumul_DCRB_lbs=cumsum(weekly_DCRB_lbs))
```
```{r}
plotdat <- weekly_dcrb
# plotdat$woy <- as.factor(plotdat$woy)
# plotdat$woy <- factor(plotdat$woy,levels=c(seq(46,53),seq(1,45)))
fig1 <- plotdat %>%
  mutate(region=ifelse(region=="central","Central","Northern")) %>%
  ggplot(aes(x=woy,y=cumul_DCRB_lbs/10000, fill=region)) +
  geom_col() +
  scale_fill_manual(values=pnw_palette("Winter",2), name="") +
  ylab("Cumulative Dungeness crab Landings (10k lbs)") + xlab("Week of Year") +
  facet_grid(rows=vars(crab_year)) + theme_bw() +
  theme(panel.grid.minor=element_blank(), panel.grid.major.x=element_blank(),
        axis.text.x=element_text(family="sans",size=8,color="black",angle=90,hjust=1,vjust=0.5),
        text=element_text(family="sans",size=12,color="black"),
        legend.text = element_text(size=12),
        axis.title=element_text(family="sans",size=14,color="black"),
        axis.text.y=element_text(family="sans",size=8,color="black"))
fig1
```

Save
```{r eval=writing}
ggsave(here::here('project-dat','figures',paste0('Fig1_cumulativeDCRBlbs_',keep_years[1],'-',substr(last(keep_years),3,4),'_byregion.png')), fig1)
```


## Figure 2

### (a) size only

```{r}
sig.lengths %<>% mutate(significance=ifelse(correct.pval<0.01,"**",significance)) %>%
  mutate(crab_years=str_replace(crab_years,"_","-")) %>%
  mutate(crab_years=fct_relevel(crab_years,c("Overall", "2013-2014", "2014-2015", "2015-2016","2016-2017","2017-2018")))
sig.lengths[6,"significance"] <- "**"
emd_means %<>%
  mutate(crab_years=str_replace(crab_years,"_","-")) %>%
  mutate(crab_years=fct_relevel(crab_years,c("Overall", "2013-2014", "2014-2015", "2015-2016","2016-2017","2017-2018")))
```

```{r}
plot.all <- emd_means %>%
  ggplot(aes(x=crab_years,y=mean.emd/1000)) +
  geom_point(size=3, aes(col=vessel_size,pch=vessel_size)) +
  geom_errorbar(aes(ymin=(mean.emd-(2*sd.emd))/1000,ymax=(mean.emd+(2*sd.emd))/1000,col=vessel_size,pch=vessel_size),width=0.25)+
  geom_text(data=sig.lengths, aes(x=crab_years,y=y+30,label=significance),size=10) +
  geom_vline(xintercept=1.5, size=2) +
  scale_color_manual(values=pnw_palette("Starfish",7)[c(1,4)]) +
  scale_shape_manual(values=c(16,2)) +
  xlab("Crab Seasons Compared") + ylab("Earth Mover's Distance (x1000)") +
  theme_bw() + theme(panel.grid.major.x=element_blank(),
                     panel.grid.minor.x=element_blank(),
                     axis.text.y=element_text(size=13),
                     axis.text.x=element_text(angle=90,hjust=1,vjust=0.5,size=14),
                     axis.title=element_text(size=16),
                     
                     legend.position="none")
plot.all
```

### (b) groups (4)

some prep for plotting is needed.
```{r}
#fix significance
sig.locals %<>% mutate(significance=ifelse(!is.na(correct.pval) & correct.pval<0.01,"**",
                                           ifelse(is.na(correct.pval) & pval<0.01,"**",significance)))
```
```{r}
sig.groups <- sig.locals %>%
   mutate(`Vessel Group`=ifelse(area=="northern","Northern",ifelse(area=="central","Central",area)),
          `Vessel Size`=NA) %>%
  mutate(y=sig.locals$y[1]-70) %>%
  mutate(crab_years=str_replace(crab_years,"_","-")) %>%
  mutate(crab_years=fct_relevel(crab_years,c("Overall", "2013-2014", "2014-2015", "2015-2016","2016-2017","2017-2018"))) %>%
  mutate(`Vessel Group`=fct_relevel(`Vessel Group`, c("Northern","Central")))

#plotdat
plotdat <- filter(emd_group_means_noncon, group != 5) %>%
  mutate(`Vessel Group`=ifelse(`Vessel Group`=="Diversified Northern","Mobile Northern",
                           ifelse(`Vessel Group`=="Central/Northern","Coastwide",`Vessel Group`))) %>%
  mutate(crab_years=str_replace(crab_years,"_","-")) %>%
  mutate(crab_years=fct_relevel(crab_years,c("Overall", "2013-2014", "2014-2015", "2015-2016","2016-2017","2017-2018")))

plotdat %<>%
  mutate(`Vessel Group`=fct_relevel(`Vessel Group`, c("Northern","Central","Mobile Northern","Coastwide")))

```
```{r} 
plot.gr <- 
ggplot(plotdat, aes(x=crab_years,y=mean.emd/1000, col=`Vessel Size`)) +
  geom_point(aes(pch=`Vessel Size`),size=2) +
  facet_wrap(~`Vessel Group`) +
  geom_errorbar(aes(pch=`Vessel Size`, ymin=(mean.emd-(2*sd.emd))/1000,ymax=(mean.emd+(2*sd.emd))/1000),width=0.25)+
  geom_vline(xintercept=1.5, size=2) +
  geom_text(data=sig.groups, aes(x=crab_years,y=y,label=significance),size=7,color="black") +
  scale_color_manual(values=c(pnw_palette("Starfish",7)[c(1,4)],"black")) +
  scale_shape_manual(values=c(16,2)) +
  xlab("Crab Seasons Compared") + ylab("") +
  theme_bw() + theme(panel.grid.major.x=element_blank(),
                     panel.grid.minor.x=element_blank(),
                     axis.text.x=element_text(angle=90,hjust=1,vjust=0.5,size=13),
                     axis.text.y=element_text(size=13),
                     strip.text=element_text(size=16),
                     axis.title=element_text(size=16),
                     legend.title=element_text(size=16),
                     legend.text=element_text(size=13))
plot.gr
```

```{r echo=FALSE, eval=writing}
png(here::here('project-dat','figures',"2013-18_EMDmeans_noncon.png"),width=750,height=400)
plot_grid(plot.all,plot.gr,rel_widths=c(0.55,1),labels="auto")
dev.off()
```
<br>



### (b) groups (2+pool)

some prep for plotting is needed.
```{r}
sig.groups <- sig.locals %>%
   mutate(`Vessel Group`=ifelse(area=="northern","Northern",ifelse(area=="central","Central",area)),
          `Vessel Size`=NA) %>%
  mutate(y=sig.locals$y[1]-110) %>%
  mutate(`Vessel Group` = fct_relevel(`Vessel Group`,c("Northern","Central","Coastwide"))) %>%
  mutate(crab_years=str_replace(crab_years,"_","-")) %>%
  mutate(crab_years=fct_relevel(crab_years,c("Overall", "2013-2014", "2014-2015", "2015-2016","2016-2017","2017-2018")))

#plotdat
plotdat <- filter(emd_group_means_noncon, !(group %in% c(3,4))) %>%
  mutate(`Vessel Group`=ifelse(`Vessel Group`=="Diversified Northern","Coastwide",`Vessel Group`)) %>%
  mutate(crab_years=str_replace(crab_years,"_","-")) %>%
  mutate(crab_years=fct_relevel(crab_years,c("Overall", "2013-2014", "2014-2015", "2015-2016","2016-2017","2017-2018"))) %>%
  mutate(`Vessel Group` = fct_relevel(`Vessel Group`, c("Northern","Central","Coastwide")))

```
```{r} 
plot.gr2 <- 
ggplot(plotdat, aes(x=crab_years,y=mean.emd/1000, col=`Vessel Size`)) +
  geom_point(aes(pch=`Vessel Size`),size=2) +
  facet_wrap(~`Vessel Group`,ncol=2) +
  geom_errorbar(aes(pch=`Vessel Size`, ymin=(mean.emd-(2*sd.emd))/1000,ymax=(mean.emd+(2*sd.emd))/1000),width=0.25)+
  geom_vline(xintercept=1.5, size=2) +
  geom_text(data=sig.groups, aes(x=crab_years,y=y,label=significance),size=7,color="black") +
  scale_color_manual(values=c(pnw_palette("Starfish",7)[c(1,4)],"black")) +
  scale_shape_manual(values=c(16,2)) +
  xlab("Crab Seasons Compared") + ylab("") +
  theme_bw() + theme(panel.grid.major.x=element_blank(),
                     panel.grid.minor.x=element_blank(),
                     axis.text.x=element_text(angle=90,hjust=1,vjust=0.5,size=13),
                     axis.text.y=element_text(size=13),
                     strip.text=element_text(size=16),
                     axis.title=element_text(size=16),
                     legend.title=element_text(size=16),
                     legend.text=element_text(size=13))
plot.gr2
```

```{r echo=FALSE, eval=writing}
png(here::here('project-dat','figures',"2013-18_EMDmeans_combocoastwide_noncon.png"),width=750,height=400)
plot_grid(plot.all,plot.gr2,rel_widths=c(0.55,1),labels="auto")
dev.off()
```
<br>

### groups (4+pool)

some prep for plotting is needed.
```{r}
sig.groups <- sig.locals %>%
   mutate(`Vessel Group`=ifelse(area=="northern","Northern",ifelse(area=="central","Central",area)),
          `Vessel Size`=NA) %>%
  mutate(y=sig.locals$y[1]-75) %>%  # just sets label position
  mutate(`Vessel Group` = fct_relevel(`Vessel Group`,c("Coastwide","Northern","Central"))) %>%
  mutate(crab_years=str_replace(crab_years,"_","-")) %>%
  mutate(crab_years=fct_relevel(crab_years,c("Overall", "2013-2014", "2014-2015", "2015-2016","2016-2017","2017-2018")))

#plotdat
plotdat <- emd_group_means_noncon %>%
  mutate(`Vessel Group`=ifelse(subgroup=="3-large","Coastwide",
                               ifelse(subgroup=="4-large","Mobile Northern",
                                      ifelse(subgroup=="5-large","cross-district pool",`Vessel Group`)))) %>%
  mutate(crab_years=str_replace(crab_years,"_","-")) %>%
  mutate(crab_years=fct_relevel(crab_years,c("Overall", "2013-2014", "2014-2015", "2015-2016","2016-2017","2017-2018"))) %>%
  mutate(`Vessel Group` = fct_relevel(`Vessel Group`, c("Mobile Northern","Coastwide","cross-district pool","Northern","Central")))
```
```{r} 
plot.gr3 <- 
ggplot(plotdat, aes(x=crab_years,y=mean.emd/1000, col=`Vessel Size`)) +
  geom_point(aes(pch=`Vessel Size`),size=2) +
  facet_wrap(~`Vessel Group`,ncol=3) +
  geom_errorbar(aes(pch=`Vessel Size`, ymin=(mean.emd-(2*sd.emd))/1000,ymax=(mean.emd+(2*sd.emd))/1000),width=0.25)+
  geom_vline(xintercept=1.5, size=2) +
  geom_text(data=sig.groups, aes(x=crab_years,y=y,label=significance),size=7,color="black") +
  scale_color_manual(values=c(pnw_palette("Starfish",7)[c(1,4)],"black")) +
  scale_shape_manual(values=c(16,2)) +
  xlab("Crab Seasons Compared") + ylab("") +
  theme_bw() + theme(panel.grid.major.x=element_blank(),
                     panel.grid.minor.x=element_blank(),
                     axis.text.x=element_text(angle=90,hjust=1,vjust=0.5,size=13),
                     axis.text.y=element_text(size=13),
                     strip.text=element_text(size=16),
                     axis.title=element_text(size=16),
                     legend.title=element_text(size=16),
                     legend.text=element_text(size=13))
plot.gr3
```

```{r echo=FALSE, eval=writing}
p.out <- plot_grid(plot.all+theme(legend.position="none",axis.title.x=element_blank(),
                                         plot.margin=margin(c(15,5,30,5))),
                   plot.gr3+theme(axis.title=element_blank(),
                                plot.margin=margin(c(15,5,30,15))),
                   rel_widths=c(0.55,1),labels=c("(a)","(b)"), label_size=16)

png(here::here('project-dat','figures',"2013-18_EMDmeans_2014groupk5_comboPLUScoastwide_noncon.png"),res=300,width=3600,height=1600)
ggdraw(add_sub(p.out, "Crab Seasons Compared", vpadding=grid::unit(0,"lines"),y=6, x=0.45, vjust=4.5,size=16))
dev.off()
```
save non-confidential plot data
```{r}
write_csv(plotdat, here::here('project-dat','statistics','2013-18_EMDmeans_2014groupk5_comboPLUScoastwide_noncon.csv'))
```


## Supplement to Fig. 2: EMD Density per year
```{r}
sfig <- ggplot(emd.dat %>% filter(crab_years %in% emd_means$crab_years),aes(x=emd/1000,fill=crab_years)) +
  geom_density(alpha=.5) +
  facet_wrap(~vessel_size, scale="free_y") +
  scale_fill_manual(values=rev(pnw_palette("Moth",10)[1:5])) +
  xlab("Earth Mover's Distance (x1000)") + ylab("Density") +
  theme_bw() + theme(legend.position="none",panel.grid.minor=element_blank(),
                     axis.text.x=element_text(angle=90,hjust=1,vjust=0.5,size=10),
                     axis.title=element_text(size=14),
                     strip.text=element_text(size=14))
sfig
```
```{r echo=FALSE, eval=writing}
png(here::here('project-dat','figures',"supplement_2013-18_EMDdistributions.png"),width=600,height=400)
sfig
dev.off()
```




## Supplement to Fig. 2: Sample Size v. Std Err

```{r}
#plotdat
plotdat <- emd_group_means_noncon %>%
  mutate(`Vessel Group`=ifelse(subgroup=="3-large","Coastwide",
                               ifelse(subgroup=="4-large","Mobile Northern",
                                      ifelse(subgroup=="5-large","cross-district pool",
                                             ifelse(group=="1","Local Central",
                                                    ifelse(group=="2","Local Northern",`Vessel Group`))))))
plotdat$crab_years <- factor(plotdat$crab_years, levels=c("Overall",
                                                          "2013_2014","2014_2015","2015_2016","2016_2017","2017_2018"))
plotdat$`Vessel Group` <- factor(plotdat$`Vessel Group`, levels=c("Mobile Northern","Coastwide","cross-district pool","Local Northern","Local Central"))

suppfig <- ggplot(plotdat,aes(x=n.vessels,y=sd.emd, col=`Vessel Size`,pch=`Vessel Group`)) +
  geom_point() +
  scale_color_manual(values=c(pnw_palette("Starfish",7)[c(1,4)],"black")) +
  ylab("EMD Std Error") + xlab("Number of Vessels in Group") + 
  theme_bw() + theme(panel.grid.major.x=element_blank(),
                     panel.grid.minor.x=element_blank(),
                     axis.text.x=element_text(angle=90,hjust=1,vjust=0.5,size=13),
                     axis.text.y=element_text(size=11),
                     axis.title=element_text(size=13),
                     legend.title=element_text(size=13),
                     legend.text=element_text(size=11))
suppfig
```
```{r echo=FALSE, eval=writing}
png(here::here('project-dat','figures',"Supplement_2013-18_EMDstderrs_v_SampleSize_2014groupk5.png"),res=200, width=1100,height=800)
suppfig
dev.off()
```



## Figures 4-5. BA index

```{r}
ba.boot.means <- ba.boot.df %>% filter(group1 != group2) %>% 
  rename("crab_year"=.id) %>% 
  group_by(crab_year,group1,group2,timeframe) %>%
  summarise(BAmean=mean(BAindex),
            BAsdev=sd(BAindex),
            BAsderr=std.error(BAindex))
ba.boot.means %<>% left_join(vgroup_summary %>% dplyr::select(-group),by=c("group1"="subgroup")) %>%
  rename(group1_area=group_area,group1_size=vessel_size) %>%
  left_join(vgroup_summary %>% dplyr::select(-group),by=c("group2"="subgroup")) %>%
  rename(group2_area=group_area,group2_size=vessel_size) %>%
  mutate(group1_area=ifelse(group1=="5-large","cross-district",group1_area),
         group2_area=ifelse(group2=="5-large","cross-district",group2_area))
```

```{r echo=FALSE, eval=writing}
write_csv(ba.boot.means,file=here(statdir,paste0('meanBAoverlap_bootstrapped_',keep_years[1],"-",substr(last(keep_years),3,4),'_annual.csv')))
```
```{r}
ba.boot.means<- read_csv(file=here(statdir,paste0('meanBAoverlap_bootstrapped_',keep_years[1],"-",substr(last(keep_years),3,4),'_annual.csv')))
```

### Fig 4: Locals
```{r}
ba.boot.locals1 <- ba.boot.means %>%
  filter((group1 %in% c("1-large","2-large")) & (group2 %in% c("1-small","2-small"))) %>%
  mutate(timeframe=ifelse(timeframe=="annual","Full Season",
                          ifelse(timeframe=="central","Central Primary","North Primary")))

ba.boot.locals1b <- ba.boot.means %>%
  filter((group2 %in% c("1-large","2-large")) & (group1 %in% c("1-small","2-small"))) %>%
  mutate(timeframe=ifelse(timeframe=="annual","Full Season",
                          ifelse(timeframe=="central","Central Primary","North Primary"))) %>%
  rename(group1=group2,group1_area=group2_area,group1_size=group2_size,
         group2=group1,group2_area=group1_area,group2_size=group1_size)

ba.boot.locals1 %<>% bind_rows(ba.boot.locals1b) %>%
  mutate(group1_area=ifelse(group1_area=="northern","Northern",
                            ifelse(group1_area=="central","Central",NA)),
         group2_area=ifelse(group2_area=="northern","Northern",
                            ifelse(group2_area=="central","Central",NA)))
```

```{r echo=FALSE}
plot.local1boot <- ggplot(ba.boot.locals1,aes(x=as.factor(crab_year),y=BAmean,col=fct_relevel(timeframe,c("Central Primary","North Primary","Full Season")),pch=fct_relevel(timeframe,c("Central Primary","North Primary","Full Season")))) +
  geom_point() +
  geom_path(aes(group=fct_relevel(timeframe,c("Central Primary","North Primary","Full Season")))) +
  geom_errorbar(aes(ymin=BAmean-(2*BAsderr),ymax=BAmean-(2*BAsderr)),width=0.5) +
  facet_grid(cols=vars(group1_size,group1_area),rows=vars(group2_size,group2_area)) +
  ylim(c(0,1)) +
  xlab("Crab Season") +
  ylab("Overlap (Bhattacharyya's affinity)") +
  scale_color_manual(values=c("#a6611a","#018571","grey60"),name="Portion of Season") +
  scale_shape_manual(values=c(19,19,4),name="Portion of Season") +
  theme_bw() + theme(panel.grid.major.y=element_blank(),panel.grid.minor.y=element_blank(),
                     strip.text=element_text(size=13),
                     axis.title=element_text(size=13),
                     axis.text.x=element_text(angle=90,hjust=1,vjust=0.6),
                     legend.title=element_text(size=13),
                     legend.text=element_text(size=12))

plot.local1boot
```


```{r echo=FALSE, eval=writing}
png(here::here('project-dat','figures',"Large_v_Small_Locals_BAoverlap-bootstrapped_2013-18.png"),res=200,width=1200,height=900)
plot.local1boot
dev.off()
```
```{r}
ba.boot.locals2 <- ba.boot.means %>%
  filter((group1 %in% c("1-large","1-small")) & (group2 %in% c("2-large","2-small"))) %>%
  filter(group1_size ==group2_size) %>%
  mutate(timeframe=ifelse(timeframe=="annual","Full Season",
                          ifelse(timeframe=="central","Central Primary","North Primary"))) %>%
  mutate(group1_area=ifelse(group1_area=="northern","Northern",
                            ifelse(group1_area=="central","Central",NA)),
         group2_area=ifelse(group2_area=="northern","Northern",
                            ifelse(group2_area=="central","Central",NA)))

ba.boot.locals2b <- ba.boot.means %>%
  filter((group2 %in% c("1-large","1-small")) & (group1 %in% c("2-large","2-small"))) %>%
  mutate(timeframe=ifelse(timeframe=="annual","Full Season",
                          ifelse(timeframe=="central","Central Primary","North Primary"))) %>%
  rename(group1=group2,group1_area=group2_area,group1_size=group2_size,
         group2=group1,group2_area=group1_area,group2_size=group1_size) %>%
  mutate(group1_area=ifelse(group1_area=="northern","Northern",
                            ifelse(group1_area=="central","Central",NA)),
         group2_area=ifelse(group2_area=="northern","Northern",
                            ifelse(group2_area=="central","Central",NA)))

```

```{r echo=FALSE}
plot.local2boot <- ba.boot.locals2 %>% 
  ggplot(aes(x=as.factor(crab_year),y=BAmean,col=fct_relevel(timeframe,c("Central Primary","North Primary","Full Season")),pch=fct_relevel(timeframe,c("Central Primary","North Primary","Full Season")))) +
  geom_point() +
  geom_path(aes(group=fct_relevel(timeframe,c("Central Primary","North Primary","Full Season")))) +
  geom_errorbar(aes(ymin=BAmean-(2*BAsderr),ymax=BAmean-(2*BAsderr)),width=0.5) +
  facet_grid(cols=vars(group1_area,group1_size),rows=vars(group2_area,group2_size), scales="free") +
  ylim(c(0,1)) +
  xlab("Crab Season") +
  ylab("Overlap (Bhattacharyya's affinity)") +
  scale_color_manual(values=c("#a6611a","#018571","grey60"),name="Portion of Season") +
  scale_shape_manual(values=c(19,19,4),name="Portion of Season") +
  theme_bw() + theme(panel.grid.major.y=element_blank(),panel.grid.minor.y=element_blank(),
                     strip.text=element_text(size=13),
                     axis.title=element_text(size=13),
                     axis.text.x=element_text(angle=90,hjust=1,vjust=0.6),
                     legend.title=element_text(size=13),
                     legend.text=element_text(size=12))

plot.local2boot
```
```{r echo=FALSE, eval=writing}
png(here::here('project-dat','figures',"LvL_SvS_Locals_BAoverlap-bootstrapped_2013-18.png"),res=200,width=1200,height=900)
plot.local2boot
dev.off()
```

```{r echo=FALSE, eval=writing}
p.out <- plot_grid(plot.local1boot+theme(legend.position="none",axis.title.x=element_blank(),
                                         plot.margin=margin(c(5,5,20,5))), 
          plot.local2boot+theme(axis.title=element_blank(),
                                plot.margin=margin(c(5,5,20,5))), 
          rel_widths=c(0.75,1),
          labels=c("(a)","(b)"))
png(here::here('project-dat','figures',"Fig4_Locals_BAoverlap-bootstrapped_2013-18.png"),res=300,width=2800,height=1400)
ggdraw(add_sub(p.out, "Crab Season", vpadding=grid::unit(0,"lines"),y=6, x=0.45, vjust=4.5))
dev.off()
```

#### fig for defense

```{r echo=FALSE}
plotdef.local1boot <- 
  ba.boot.locals1 %>%
  filter(timeframe=="Central Primary" | timeframe=="Full Season") %>%
  mutate(timeframe=ifelse(timeframe=="Central Primary", "First 6 weeks",timeframe)) %>%
  filter(group1_area=="Northern" & group2_area=="Central") %>%
  ggplot(aes(x=as.factor(crab_year),y=BAmean,col=fct_relevel(timeframe,c("First 6 weeks","Full Season")),pch=fct_relevel(timeframe,c("First 6 weeks","Full Season")))) +
  geom_point() +
  geom_path(aes(group=fct_relevel(timeframe,c("First 6 weeks","Full Season")))) +
  geom_errorbar(aes(ymin=BAmean-(2*BAsderr),ymax=BAmean-(2*BAsderr)),width=0.5) +
  xlab("Crab Season") +
  ylab("Overlap\n (Bhattacharyya's affinity)") +
  scale_color_manual(values=c("#a6611a","black"),name="") +
  scale_shape_manual(values=c(19,19,4),name="") +
  scale_y_continuous(limits=c(0,1), breaks=c(0,0.5,1.0), labels=c("0 (None)","0.5","1.0 (All)")) +
  theme_bw() + theme(panel.grid.major.y=element_blank(),panel.grid.minor.y=element_blank(),
                     strip.text=element_text(size=13),
                     axis.title=element_text(size=13),
                     axis.text.x=element_text(angle=90,hjust=1,vjust=0.6),
                     legend.title=element_text(size=13),
                     legend.text=element_text(size=12))

plotdef2.local1boot <- 
  ba.boot.locals1 %>%
  filter(timeframe=="Central Primary" | timeframe=="Full Season") %>%
  mutate(timeframe=ifelse(timeframe=="Central Primary", "First 6 weeks",timeframe)) %>%
  filter(group1_area=="Northern" & group2_area=="Central") %>%
  ggplot(aes(x=as.factor(crab_year),y=BAmean,col=fct_relevel(timeframe,c("First 6 weeks","Full Season")),pch=fct_relevel(timeframe,c("First 6 weeks","Full Season")))) +
  geom_point() +
  geom_path(aes(group=fct_relevel(timeframe,c("First 6 weeks","Full Season")))) +
  geom_errorbar(aes(ymin=BAmean-(2*BAsderr),ymax=BAmean-(2*BAsderr)),width=0.5) +
  ylab("Overlap\n (Bhattacharyya's affinity)") +
  scale_color_manual(values=c("#a6611a","white"),name="") +
  scale_shape_manual(values=c(19,19,4),name="") +
  scale_y_continuous(limits=c(0,1), breaks=c(0,0.5,1.0), labels=c("0 (None)","0.5","1.0 (All)")) +
  theme_bw() + theme(panel.grid.major.y=element_blank(),panel.grid.minor.y=element_blank(),
                     strip.text=element_text(size=13),
                     axis.title.y=element_text(size=13),axis.title.x=element_blank(),
                     axis.text.x=element_text(angle=90,hjust=1,vjust=0.6,size=13),
                     axis.text.y=element_text(size=13),
                     legend.position="none")


png(here::here('project-dat','figures',"phd_LgNvSmC_Locals_CentralPrimary_BAoverlap-bootstrapped_2013-18.png"),res=300,width=1700,height=1100)
plotdef2.local1boot
dev.off()
```


### Fig 5: mobile v local

first, separate out the mobile northern and coastwide groups
```{r}
ba.boot.contrast1 <- ba.boot.means %>%
  filter((group1 %in% c("4-large","3-large")) & (group2 %in% c("1-large","2-large","1-small","2-small"))) %>%
  mutate(timeframe=ifelse(timeframe=="annual","Full Season",
                          ifelse(timeframe=="central","Central Primary","North Primary")))

ba.boot.contrast1b <- ba.boot.means %>%
  filter((group1 %in% c("1-large","2-large","1-small","2-small")) & (group2 %in% c("4-large","3-large"))) %>%
  mutate(timeframe=ifelse(timeframe=="annual","Full Season",
                          ifelse(timeframe=="central","Central Primary","North Primary"))) %>%
  rename(group1=group2,group1_area=group2_area,group1_size=group2_size,
         group2=group1,group2_area=group1_area,group2_size=group1_size) %>%
  mutate(timeframe=as.character(timeframe))

if(dim(ba.boot.contrast1)[1] > 0){
  if(dim(ba.boot.contrast1b)[1] > 0){
    ba.boot.contrast1 %<>% bind_rows(ba.boot.contrast1b)
  }
} else if(dim(ba.boot.contrast1b)[1] > 0){
  ba.boot.contrast1 <- ba.boot.contrast1b
}

ba.boot.contrast1 %<>% mutate(group1_area=ifelse(group1=="3-large","coastwide","mobile northern"))
```

```{r echo=FALSE}
plot.contrast1boot <- ggplot(ba.boot.contrast1,aes(x=as.factor(crab_year),y=BAmean,col=fct_relevel(timeframe,c("Central Primary","North Primary","Full Season")),pch=fct_relevel(timeframe,c("Central Primary","North Primary","Full Season")))) +
  geom_point() +
  geom_path(aes(group=fct_relevel(timeframe,c("Central Primary","North Primary","Full Season")))) +
  geom_errorbar(aes(ymin=BAmean-BAsderr,ymax=BAmean-BAsderr),width=0.5) +
  facet_grid(cols=vars(group2_size,group2_area),rows=vars(group1_size,group1_area)) +
  # ylim(c(0,1)) +
  xlab("Crab Season") +
  ylab("Overlap (Bhattacharyya's affinity)") +
  scale_color_manual(values=c("#a6611a","#018571","grey60"),name="Portion of Season") +
  scale_shape_manual(values=c(19,19,4),name="Portion of Season") +
  theme_bw() + theme(panel.grid.major.y=element_blank(),panel.grid.minor.y=element_blank(),
                     strip.text=element_text(size=13),
                     axis.title=element_text(size=13),
                     axis.text.x=element_text(angle=90,hjust=1,vjust=0.6),
                     legend.title=element_text(size=13),
                     legend.text=element_text(size=12))

plot.contrast1boot
```
```{r echo=FALSE, eval=writing}
png(here::here('project-dat','figures',"Coastwide3Mobile4_v_Locals_BAoverlap-bootstrapped_2013-18.png"),res=200,width=1600,height=1000)
plot.contrast1boot
dev.off()
```

now, combine the mobile groups: **Figure 5**
```{r}
ba.boot.contrast2 <- ba.boot.means %>%
  filter((group1 %in% c("5-large")) & (group2 %in% c("1-large","2-large","1-small","2-small")))

ba.boot.contrast2b <- ba.boot.means %>%
  filter((group1 %in% c("1-large","2-large","1-small","2-small")) & (group2 %in% c("5-large"))) %>%
  mutate(timeframe=ifelse(timeframe=="annual","Full Season",
                          ifelse(timeframe=="central","Central Primary","North Primary"))) %>%
  rename(group1=group2,group1_area=group2_area,group1_size=group2_size,
         group2=group1,group2_area=group1_area,group2_size=group1_size)

if(dim(ba.boot.contrast2)[1] > 0){
  if(dim(ba.boot.contrast2b)[1] > 0){
    ba.boot.contrast2 %<>%
  mutate(timeframe=ifelse(timeframe=="annual","Full Season",
                          ifelse(timeframe=="central","Central Primary","North Primary"))) %>%
      bind_rows(ba.boot.contrast2b)  %>%
  mutate(group1_area=ifelse(group1_area=="northern","Northern",
                            ifelse(group1_area=="central","Central","cross-district pool")),
         group2_area=ifelse(group2_area=="northern","Northern",
                            ifelse(group2_area=="central","Central","cross-district pool")))
  }
} else if(dim(ba.boot.contrast2b)[1] > 0){
  ba.boot.contrast2 <- ba.boot.contrast2b  %>%
  mutate(group1_area=ifelse(group1_area=="northern","Northern",
                            ifelse(group1_area=="central","Central","cross-district pool")),
         group2_area=ifelse(group2_area=="northern","Northern",
                            ifelse(group2_area=="central","Central","cross-district pool")))
}
```

```{r echo=FALSE}
plot.contrast2boot <- ggplot(ba.boot.contrast2,aes(x=as.factor(crab_year),y=BAmean,col=fct_relevel(timeframe,c("Central Primary","North Primary","Full Season")),pch=fct_relevel(timeframe,c("Central Primary","North Primary","Full Season")))) +
  geom_point() +
  geom_path(aes(group=fct_relevel(timeframe,c("Central Primary","North Primary","Full Season")))) +
  geom_errorbar(aes(ymin=BAmean-(2*BAsderr),ymax=BAmean-(2*BAsderr)),width=0.5) +
  facet_grid(cols=vars(group2_size,group2_area),rows=vars(group1_size,group1_area)) +
  ylim(c(0,1)) +
  xlab("Crab Season") +
  ylab("Overlap (Bhattacharyya's affinity)") +
  scale_color_manual(values=c("#a6611a","#018571","grey60"),name="Portion of Season") +
  scale_shape_manual(values=c(19,19,4),name="Portion of Season") +
  theme_bw() + theme(panel.grid.major.y=element_blank(),panel.grid.minor.y=element_blank(),
                     strip.text=element_text(size=13),
                     axis.title=element_text(size=13),
                     axis.text.x=element_text(angle=90,hjust=1,vjust=0.6),
                     legend.title=element_text(size=13),
                     legend.text=element_text(size=12))

plot.contrast2boot
```
```{r echo=FALSE, eval=writing}
png(here::here('project-dat','figures',"Fig5_Mobile5_v_Locals_BAoverlap-bootstrapped_2013-18.png"),res=300,width=2100,height=1200)
plot.contrast2boot
dev.off()
```


## Figures 4-5. BA index (PROJ6)

```{r}
ba.boot.means <- ba.boot.df %>% filter(group1 != group2) %>% 
  rename("crab_year"=.id) %>% 
  group_by(crab_year,group1,group2,timeframe) %>%
  summarise(BAmean=mean(BAindex),
            BAsdev=sd(BAindex),
            BAsderr=std.error(BAindex))
ba.boot.means %<>% left_join(vgroup_summary %>% dplyr::select(-group),by=c("group1"="subgroup")) %>%
  rename(group1_area=group_area,group1_size=vessel_size) %>%
  left_join(vgroup_summary %>% dplyr::select(-group),by=c("group2"="subgroup")) %>%
  rename(group2_area=group_area,group2_size=vessel_size) %>%
  mutate(group1_area=ifelse(group1=="5-large","cross-district",group1_area),
         group2_area=ifelse(group2=="5-large","cross-district",group2_area))
```

```{r echo=FALSE, eval=writing}
write_csv(ba.boot.means,file=here(statdir,paste0('meanBAoverlap_bootstrappedPROJ6_',keep_years[1],"-",substr(last(keep_years),3,4),'_annual.csv')))
```


### Fig 4: Locals
```{r}
ba.boot.locals1 <- ba.boot.means %>%
  filter((group1 %in% c("1-large","2-large")) & (group2 %in% c("1-small","2-small"))) %>%
  mutate(timeframe=ifelse(timeframe=="annual","Full Season",
                          ifelse(timeframe=="central","Central Primary","North Primary")))

ba.boot.locals1b <- ba.boot.means %>%
  filter((group2 %in% c("1-large","2-large")) & (group1 %in% c("1-small","2-small"))) %>%
  mutate(timeframe=ifelse(timeframe=="annual","Full Season",
                          ifelse(timeframe=="central","Central Primary","North Primary"))) %>%
  rename(group1=group2,group1_area=group2_area,group1_size=group2_size,
         group2=group1,group2_area=group1_area,group2_size=group1_size)

ba.boot.locals1 %<>% bind_rows(ba.boot.locals1b) %>%
  mutate(group1_area=ifelse(group1_area=="northern","Northern",
                            ifelse(group1_area=="central","Central",NA)),
         group2_area=ifelse(group2_area=="northern","Northern",
                            ifelse(group2_area=="central","Central",NA)))
```

```{r echo=FALSE}
plot.local1boot <- ggplot(ba.boot.locals1,aes(x=as.factor(crab_year),y=BAmean,col=fct_relevel(timeframe,c("Central Primary","North Primary","Full Season")),pch=fct_relevel(timeframe,c("Central Primary","North Primary","Full Season")))) +
  geom_point() +
  geom_path(aes(group=fct_relevel(timeframe,c("Central Primary","North Primary","Full Season")))) +
  geom_errorbar(aes(ymin=BAmean-(2*BAsderr),ymax=BAmean-(2*BAsderr)),width=0.5) +
  facet_grid(cols=vars(group1_size,group1_area),rows=vars(group2_size,group2_area)) +
  ylim(c(0,1)) +
  xlab("Crab Season") +
  ylab("Overlap (Bhattacharyya's affinity)") +
  scale_color_manual(values=c("#a6611a","#018571","grey60"),name="Portion of Season") +
  scale_shape_manual(values=c(19,19,4),name="Portion of Season") +
  theme_bw() + theme(panel.grid.major.y=element_blank(),panel.grid.minor.y=element_blank(),
                     strip.text=element_text(size=13),
                     axis.title=element_text(size=13),
                     axis.text.x=element_text(angle=90,hjust=1,vjust=0.6),
                     legend.title=element_text(size=13),
                     legend.text=element_text(size=12))

plot.local1boot
```


```{r echo=FALSE, eval=writing}
png(here::here('project-dat','figures',"Large_v_Small_Locals_BAoverlap-bootstrappedPROJ6_2013-18.png"),res=200,width=1200,height=900)
plot.local1boot
dev.off()
```
```{r}
ba.boot.locals2 <- ba.boot.means %>%
  filter((group1 %in% c("1-large","1-small")) & (group2 %in% c("2-large","2-small"))) %>%
  filter(group1_size ==group2_size) %>%
  mutate(timeframe=ifelse(timeframe=="annual","Full Season",
                          ifelse(timeframe=="central","Central Primary","North Primary"))) %>%
  mutate(group1_area=ifelse(group1_area=="northern","Northern",
                            ifelse(group1_area=="central","Central",NA)),
         group2_area=ifelse(group2_area=="northern","Northern",
                            ifelse(group2_area=="central","Central",NA)))

ba.boot.locals2b <- ba.boot.means %>%
  filter((group2 %in% c("1-large","1-small")) & (group1 %in% c("2-large","2-small"))) %>%
  mutate(timeframe=ifelse(timeframe=="annual","Full Season",
                          ifelse(timeframe=="central","Central Primary","North Primary"))) %>%
  rename(group1=group2,group1_area=group2_area,group1_size=group2_size,
         group2=group1,group2_area=group1_area,group2_size=group1_size) %>%
  mutate(group1_area=ifelse(group1_area=="northern","Northern",
                            ifelse(group1_area=="central","Central",NA)),
         group2_area=ifelse(group2_area=="northern","Northern",
                            ifelse(group2_area=="central","Central",NA)))

```

```{r echo=FALSE}
plot.local2boot <- ba.boot.locals2 %>% 
  ggplot(aes(x=as.factor(crab_year),y=BAmean,col=fct_relevel(timeframe,c("Central Primary","North Primary","Full Season")),pch=fct_relevel(timeframe,c("Central Primary","North Primary","Full Season")))) +
  geom_point() +
  geom_path(aes(group=fct_relevel(timeframe,c("Central Primary","North Primary","Full Season")))) +
  geom_errorbar(aes(ymin=BAmean-(2*BAsderr),ymax=BAmean-(2*BAsderr)),width=0.5) +
  facet_grid(cols=vars(group1_area,group1_size),rows=vars(group2_area,group2_size), scales="free") +
  ylim(c(0,1)) +
  xlab("Crab Season") +
  ylab("Overlap (Bhattacharyya's affinity)") +
  scale_color_manual(values=c("#a6611a","#018571","grey60"),name="Portion of Season") +
  scale_shape_manual(values=c(19,19,4),name="Portion of Season") +
  theme_bw() + theme(panel.grid.major.y=element_blank(),panel.grid.minor.y=element_blank(),
                     strip.text=element_text(size=13),
                     axis.title=element_text(size=13),
                     axis.text.x=element_text(angle=90,hjust=1,vjust=0.6),
                     legend.title=element_text(size=13),
                     legend.text=element_text(size=12))

plot.local2boot
```
```{r echo=FALSE, eval=writing}
png(here::here('project-dat','figures',"LvL_SvS_Locals_BAoverlap-bootstrappedPROJ6_2013-18.png"),res=200,width=1200,height=900)
plot.local2boot
dev.off()
```

```{r echo=FALSE, eval=writing}
p.out <- plot_grid(plot.local1boot+theme(legend.position="none",axis.title.x=element_blank(),
                                         plot.margin=margin(c(5,5,20,5))), 
          plot.local2boot+theme(axis.title=element_blank(),
                                plot.margin=margin(c(5,5,20,5))), 
          rel_widths=c(0.75,1),
          labels=c("(a)","(b)"))
png(here::here('project-dat','figures',"Fig4_Locals_BAoverlap-bootstrappedPROJ6_2013-18.png"),res=300,width=2800,height=1400)
ggdraw(add_sub(p.out, "Crab Season", vpadding=grid::unit(0,"lines"),y=6, x=0.45, vjust=4.5))
dev.off()
```


### Fig 5: mobile v local

first, separate out the mobile northern and coastwide groups
```{r}
ba.boot.contrast1 <- ba.boot.means %>%
  filter((group1 %in% c("4-large","3-large")) & (group2 %in% c("1-large","2-large","1-small","2-small"))) %>%
  mutate(timeframe=ifelse(timeframe=="annual","Full Season",
                          ifelse(timeframe=="central","Central Primary","North Primary")))

ba.boot.contrast1b <- ba.boot.means %>%
  filter((group1 %in% c("1-large","2-large","1-small","2-small")) & (group2 %in% c("4-large","3-large"))) %>%
  mutate(timeframe=ifelse(timeframe=="annual","Full Season",
                          ifelse(timeframe=="central","Central Primary","North Primary"))) %>%
  rename(group1=group2,group1_area=group2_area,group1_size=group2_size,
         group2=group1,group2_area=group1_area,group2_size=group1_size) %>%
  mutate(timeframe=as.character(timeframe))

if(dim(ba.boot.contrast1)[1] > 0){
  if(dim(ba.boot.contrast1b)[1] > 0){
    ba.boot.contrast1 %<>% bind_rows(ba.boot.contrast1b)
  }
} else if(dim(ba.boot.contrast1b)[1] > 0){
  ba.boot.contrast1 <- ba.boot.contrast1b
}

ba.boot.contrast1 %<>% mutate(group1_area=ifelse(group1=="3-large","coastwide","mobile northern"))
```

```{r echo=FALSE}
plot.contrast1boot <- ggplot(ba.boot.contrast1,aes(x=as.factor(crab_year),y=BAmean,col=fct_relevel(timeframe,c("Central Primary","North Primary","Full Season")),pch=fct_relevel(timeframe,c("Central Primary","North Primary","Full Season")))) +
  geom_point() +
  geom_path(aes(group=fct_relevel(timeframe,c("Central Primary","North Primary","Full Season")))) +
  geom_errorbar(aes(ymin=BAmean-BAsderr,ymax=BAmean-BAsderr),width=0.5) +
  facet_grid(cols=vars(group2_size,group2_area),rows=vars(group1_size,group1_area)) +
  # ylim(c(0,1)) +
  xlab("Crab Season") +
  ylab("Overlap (Bhattacharyya's affinity)") +
  scale_color_manual(values=c("#a6611a","#018571","grey60"),name="Portion of Season") +
  scale_shape_manual(values=c(19,19,4),name="Portion of Season") +
  theme_bw() + theme(panel.grid.major.y=element_blank(),panel.grid.minor.y=element_blank(),
                     strip.text=element_text(size=13),
                     axis.title=element_text(size=13),
                     axis.text.x=element_text(angle=90,hjust=1,vjust=0.6),
                     legend.title=element_text(size=13),
                     legend.text=element_text(size=12))

plot.contrast1boot
```
```{r echo=FALSE, eval=writing}
png(here::here('project-dat','figures',"Coastwide3Mobile4_v_Locals_BAoverlap-bootstrapped_2013-18.png"),res=200,width=1600,height=1000)
plot.contrast1boot
dev.off()
```

now, combine the mobile groups: **Figure 5**
```{r}
ba.boot.contrast2 <- ba.boot.means %>%
  filter((group1 %in% c("5-large")) & (group2 %in% c("1-large","2-large","1-small","2-small")))

ba.boot.contrast2b <- ba.boot.means %>%
  filter((group1 %in% c("1-large","2-large","1-small","2-small")) & (group2 %in% c("5-large"))) %>%
  mutate(timeframe=ifelse(timeframe=="annual","Full Season",
                          ifelse(timeframe=="central","Central Primary","North Primary"))) %>%
  rename(group1=group2,group1_area=group2_area,group1_size=group2_size,
         group2=group1,group2_area=group1_area,group2_size=group1_size)

if(dim(ba.boot.contrast2)[1] > 0){
  if(dim(ba.boot.contrast2b)[1] > 0){
    ba.boot.contrast2 %<>%
  mutate(timeframe=ifelse(timeframe=="annual","Full Season",
                          ifelse(timeframe=="central","Central Primary","North Primary"))) %>%
      bind_rows(ba.boot.contrast2b)  %>%
  mutate(group1_area=ifelse(group1_area=="northern","Northern",
                            ifelse(group1_area=="central","Central","cross-district pool")),
         group2_area=ifelse(group2_area=="northern","Northern",
                            ifelse(group2_area=="central","Central","cross-district pool")))
  }
} else if(dim(ba.boot.contrast2b)[1] > 0){
  ba.boot.contrast2 <- ba.boot.contrast2b  %>%
  mutate(group1_area=ifelse(group1_area=="northern","Northern",
                            ifelse(group1_area=="central","Central","cross-district pool")),
         group2_area=ifelse(group2_area=="northern","Northern",
                            ifelse(group2_area=="central","Central","cross-district pool")))
}
```

```{r echo=FALSE}
plot.contrast2boot <- ggplot(ba.boot.contrast2,aes(x=as.factor(crab_year),y=BAmean,col=fct_relevel(timeframe,c("Central Primary","North Primary","Full Season")),pch=fct_relevel(timeframe,c("Central Primary","North Primary","Full Season")))) +
  geom_point() +
  geom_path(aes(group=fct_relevel(timeframe,c("Central Primary","North Primary","Full Season")))) +
  geom_errorbar(aes(ymin=BAmean-(2*BAsderr),ymax=BAmean-(2*BAsderr)),width=0.5) +
  facet_grid(cols=vars(group2_size,group2_area),rows=vars(group1_size,group1_area)) +
  ylim(c(0,1)) +
  xlab("Crab Season") +
  ylab("Overlap (Bhattacharyya's affinity)") +
  scale_color_manual(values=c("#a6611a","#018571","grey60"),name="Portion of Season") +
  scale_shape_manual(values=c(19,19,4),name="Portion of Season") +
  theme_bw() + theme(panel.grid.major.y=element_blank(),panel.grid.minor.y=element_blank(),
                     strip.text=element_text(size=13),
                     axis.title=element_text(size=13),
                     axis.text.x=element_text(angle=90,hjust=1,vjust=0.6),
                     legend.title=element_text(size=13),
                     legend.text=element_text(size=12))

plot.contrast2boot
```
```{r echo=FALSE, eval=writing}
png(here::here('project-dat','figures',"Fig5_Mobile5_v_Locals_BAoverlap-bootstrappedPROJ6_2013-18.png"),res=300,width=2100,height=1200)
plot.contrast2boot
dev.off()
```


## Supplement to Fig 4-5: BA v. sample size (PROJ 6)

Create a three panel figure showing the BA overlap between any two groups, with the x axis as (1) group 1 sample size, (2) group 2 sample size, (3) combined sample size, (4) difference in sample size

First, grab sample sizes from vessel groups data frame and append to the BA means data frame
```{r}
ba.boot.means.n <- ba.boot.means %>%
  left_join(vgroups %>% 
              group_by(subgroup,crab_year) %>% 
              summarise(n.group1=length(unique(drvid))) %>%
              rename(group1=subgroup), by=c("group1","crab_year")) %>%
  left_join(vgroups %>% 
              group_by(subgroup,crab_year) %>% 
              summarise(n.group2=length(unique(drvid))) %>%
              rename(group2=subgroup), by=c("group2","crab_year"))
```
```{r}
figs_baVn <- ba.boot.means.n %>% ungroup() %>%
  dplyr::select(crab_year,BAmean,n.group1,n.group2) %>%
  mutate(Difference=abs(n.group1-n.group2),Sum=n.group1+n.group2) %>%
  rename(`Group 1 N`=n.group1,`Group 2 N`=n.group2,`Crab Season`=crab_year) %>%
  pivot_longer(cols=c(`Group 1 N`,`Group 2 N`,Difference,Sum),names_to="sample",values_to="sample_size") %>%
  mutate(sample=factor(sample, levels=c("Group 1 N","Group 2 N","Sum","Difference"))) %>%
  ggplot(aes(x=sample_size,y=BAmean,col=`Crab Season`)) +
  geom_point() +
  facet_grid(cols=vars(sample), rows=vars(as.factor(`Crab Season`))) + 
  labs(y="Overlap (BA index)", x="Count") + theme_bw() + theme(legend.position="none")

figs_baVn
```
```{r echo=FALSE, eval=writing}
png(here::here('project-dat','figures',"FigS_BAoverlap-bootstrappedPROJ6_v_SubgroupSampleSize_2013-18.png"),res=200,width=1200,height=1000)
figs_baVn
dev.off()
```


## Figure X. Map UDs

### map objects

Basemap
```{r fig.height=4, fig.width=3}
data(stateMapEnv)
states_df <- map_data("state") %>%
  filter(region %in% c("california"))
states_df_sp <- states_df
coordinates(states_df_sp) <- c("long", "lat")
proj4string(states_df_sp) <- CRS("+init=epsg:4326") # WGS 84
# states_geo <- spTransform(states_df_sp, CRS("+init=epsg:32610"))
states_geo_df <- as.data.frame(states_df_sp)

states_df_coast <- filter(states_df,long < -116) %>%
  filter(!(long > -120.5 & lat > 32.5)) %>%
  filter(!(long > -122.5 & lat > 38.1))

# check the outline
ggplot(data=states_df_coast, aes(x=long,y=lat,group=group)) + geom_path()
```


port group points
```{r}
pg <- read.csv(here::here('project-dat','pcgroup_mean_coordinates.csv'))
pg$port_group <- c("Bodega Bay","Fort Bragg","Crescent City","Eureka","Monterey","Morro Bay","San Francisco")
coordinates(pg) <- c("Lon", "Lat")
proj4string(pg) <- CRS("+init=epsg:4326") # WGS 84
# pg_geo <- spTransform(pg, CRS("+init=epsg:32610"))
pg_df <- as.data.frame(pg)


pg_df$port_group_label <- pg_df$port_group_name
pg_df$port_group_label[which(pg_df$port_group_label=="Morro Bay")] <- "Morro\nBay"
pg_df$port_group_label[which(pg_df$port_group_label=="San Francisco")] <- "\nSan Francisco"
```


Check to make sure that the correct objects were read in above.
```{r eval=FALSE}
n_uds <- udlist2$`1-small`
y=2014
nyr_ud <- n_uds[n_uds$id==y,]

ggplot() +
      geom_polygon(data=states_geo_df, aes(x=long, y=lat, group=group), fill="grey87",linetype=1) +
      geom_point(data=pg_df, aes(x=Lon,y=Lat), color="black") +
  geom_polygon(data=nyr_ud, aes(x=long,y=lat, group=group)) + ggtitle(y) + theme_void()
```

Map small locals
```{r}
key_filter <- filter(vgroup_summary, subgroup %in% c("1-small","2-small"))

north_uds <- udlist[["2-small"]]
central_uds <- udlist[["1-small"]]

myplot_sm <- map_fishing_stacked2(north_uds=north_uds,central_uds=central_uds,key=key_filter,keep_years=keep_years,states_df_coast=states_df_coast)

myplot_sm <- myplot_sm  + annotate("rect",xmin=-125,xmax=-124.5,ymin=36,ymax=35.5,alpha=0.7,fill=pnw_palette("Bay",n=5)[1]) +
  annotate("rect",xmin=-125,xmax=-124.5,ymin=34.9,ymax=35.4,alpha=0.7,fill=pnw_palette("Bay",n=5)[4]) +
  annotate("text",x=-123.5,y=35.8,label="Local North") +
  annotate("text",x=-123.38,y=35.2,label="Local Central")
```

```{r echo=FALSE, eval=writing}
png(here::here('project-dat','figures',"change_90ud_annual_SmLocal_byRegion_2stack.png"),res=300, height=1500, width=1800)
myplot_sm
dev.off()
```



Map large locals

```{r}
key_filter <- filter(vgroup_summary, subgroup %in% c("1-large","2-large"))

north_uds <- udlist[["2-large"]]
central_uds <- udlist[["1-large"]]

myplot_lg <- map_fishing_stacked2(north_uds=north_uds,central_uds=central_uds,key=key_filter,keep_years=keep_years,states_df_coast=states_df_coast)

myplot_lg <- myplot_lg + annotate("rect",xmin=-125,xmax=-124.5,ymin=36,ymax=35.5,alpha=0.7,fill=pnw_palette("Bay",n=5)[1]) +
  annotate("rect",xmin=-125,xmax=-124.5,ymin=34.9,ymax=35.4,alpha=0.7,fill=pnw_palette("Bay",n=5)[4]) +
  annotate("text",x=-123.5,y=35.8,label="Local North") +
  annotate("text",x=-123.38,y=35.2,label="Local Central")
```

```{r echo=FALSE, eval=writing}
png(here::here('project-dat','figures',"change_90ud_annual_LgLocal_byRegion_2stack.png"),res=300, height=1500, width=1800)
myplot_lg
dev.off()
```




Map cross-district pool
```{r}
key_filter <- filter(vgroup_summary, subgroup %in% c("5-large"))
cross_uds <- udlist[["5-large"]]

myplot_cd <- map_fishing_stacked(ud_list=cross_uds,key=key_filter,keep_years=keep_years,states_df_coast=states_df_coast, udcol=pnw_palette("Shuksan",n=8)[4])
```

```{r echo=FALSE, eval=writing}
png(here::here('project-dat','figures',"change_90ud_annual_LgCrossDistrict_2stack.png"),res=300, height=1500, width=1800)
myplot_cd
dev.off()
```

Stack them all!
```{r eval=writing}
png(here::here('project-dat','figures',"change_90ud_annual_All_byRegion_stacked.png"),res=300,height=4000, width=1800)
plot_grid(myplot_sm,myplot_lg,myplot_cd,nrow=3, labels=c("a","b","c"))
dev.off()
```





Map small locals, according to QC
```{r}
key_filter <- filter(vgroup_summary, subgroup %in% c("1-small","2-small"))

north_uds <- udlist2[["2-small"]]
central_uds <- udlist2[["1-small"]]

myplot_sm2 <- map_fishing_stacked2(north_uds=north_uds,central_uds=central_uds,key=key_filter,keep_years=keep_years,states_df_coast=states_df_coast)

myplot_sm2 <- myplot_sm2  + annotate("rect",xmin=-125,xmax=-124.5,ymin=36,ymax=35.5,alpha=0.7,fill=pnw_palette("Bay",n=5)[1]) +
  annotate("rect",xmin=-125,xmax=-124.5,ymin=34.9,ymax=35.4,alpha=0.7,fill=pnw_palette("Bay",n=5)[4]) +
  annotate("text",x=-123.5,y=35.8,label="Local North") +
  annotate("text",x=-123.38,y=35.2,label="Local Central")
```

```{r echo=FALSE, eval=writing}
png(here::here('project-dat','figures',"change_90ud_annual_SmLocal_byRegion_2stack_QCsub.png"),res=300, height=1500, width=1800)
myplot_sm2
dev.off()
```

